var util=require("common:static/js/util.js"),searchData=require("common:static/js/searchdata.js"),Coords=require("subway:static/js/base/coords.js"),Station=require("subway:static/js/base/station.js"),Line=require("subway:static/js/base/line.js");define("subway:static/js/base/subway.js",function(t,i,n){function e(t,i,n){this.fullName=i,this.shortName=t,this.lines_number=n,this.lines=[],this.width=null,this.height=null}e.prototype.findBy=function(t){var i=[];if("function"==typeof t)for(var n,e=this.lines.length-1;e>=0;e--){n=this.lines[e],t.apply(n)&&i.push(n);for(var s=n.stations.length-1;s>=0;s--){var a=n.stations[s];t.apply(a)&&i.push(a)}}return i},e.prototype.findNearestStation=function(t,i,n){var e=Number.POSITIVE_INFINITY,s=0,a=null,o="point"===i?"p":"";if(t&&t.x&&t.y)for(var r=this.lines,u=0;u<r.length;u++)for(var h=r[u],l=0;l<h.stations.length;l++){var f=h.stations[l];f.iu&&(s=Math.pow(f[o+"x"]-t.x,2)+Math.pow(f[o+"y"]-t.y,2),e>s&&(e=s,a=f))}if(!(n>0&&e>n*n))return a},e.prototype.findLineOneWayDirection=function(t,i){var n,e;if(i){var s=this.findBy(function(){return this instanceof Station&&this.st&&this.sid&&this.lid==t.lid&&this.sid==i});if(0===s.length)n=t.stations[0],e=t.stations[t.stations.length-1];else if(n=s[0],t.stations[0]==n){for(var a=t.stations.length-1;a>0;a--)if(t.stations[a].st){e=t.stations[a];break}}else for(var o=0;o<t.stations.length;o++)if(t.stations[o].st){e=t.stations[o];break}}else n=t.stations[0],e=t.stations[t.stations.length-1];return{firstStation:n,lastStation:e}},e.prototype.parseStationExt=function(t){var i=this;if(t&&t.content&&t.content.ext&&t.content.ext.line_info){var n={},e=[];$.each(t.content.ext.line_info,function(t,s){var a=s.line_name;if(void 0===n[a]){var o=i.findBy(function(){return this instanceof Line&&this.lid.indexOf(a)>=0});0===o.length?e.push(s):n[a]={line:o[0],ext:[s]}}else n[a].ext.push(s)}),$.each(e,function(t,e){var s=e.line_name,a=e.terminals,o=i.findBy(function(){return this instanceof Line&&0===this.lid.indexOf(s)&&this.lid.indexOf(a)>0});0!==o.length&&$.each(o,function(t,i){var s=i.lid;if(void 0===n[s])n[s]={line:i,ext:[e],lost:!0};else{var a=!1;$.each(n[s].ext,function(t,i){i.terminals==e.terminals&&(a=!0)}),a||n[s].ext.push(e)}})});var s=[];$.each(n,function(t,i){i.lost&&1==i.ext.length&&s.push(t)}),$.each(s,function(t,i){n[i]=null,delete n[i]});var a=[];$.each(n,function(t,i){var n=i.line,e=i.ext,s={};s.color=n.lc,s.name=n.lid,s.dirs=[],$.each(e,function(t,i){s.dirs.push({name:i.terminals,startTime:i.first_time,endTime:i.last_time})}),a.push(s)});var o=i.findBy(function(){return this instanceof Station&&this.st&&this.uid===t.content.uid});if(0===o.length&&(o=this.findBy(function(){return this instanceof Station&&this.st&&this.sid&&0===t.content.name.indexOf(this.sid)}),0===o.length))return;var r=o[0],u=util.parseGeo(t.content.geo).points;return{station:r,points:u,lines:a}}},e.prototype.getStationExt=function(t,i,n,e){var s=this;s._currentQueryUID=i;var a="qt="+t+"&c="+this.cityCode+"&uid="+i;searchData.fetch(a,function(t){i===s._currentQueryUID&&(s._currentQueryUID=null,t=s.parseStationExt(t),n&&n(t))},function(t){e&&e(t)})},n.exports=e});