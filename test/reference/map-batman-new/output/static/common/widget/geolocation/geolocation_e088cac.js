define("common:widget/geolocation/geolocation.js",function(t,o,e){t("common:static/js/gmu/src/core/widget.js");var i=t("common:widget/geolocation/html5geolocation.js"),a=t("common:widget/geolocation/nativegeolocation.js"),s=t("common:widget/geolocation/sharegeolocation.js"),n=t("common:widget/geolocation/preciseipgeolocation.js"),c=t("common:widget/geolocation/urlgeolocation.js"),r=t("common:widget/geolocation/myposition.js"),m=(t("common:widget/geolocation/location.js"),t("common:widget/stat/metrics-stat.js")),_=t("common:static/js/util.js"),g=t("common:static/js/localstorage.js");t("common:widget/url/url.js"),e.exports={_IS_LAST_GEO_FAIL:!1,_GEO_METHOD_INDEX:0,_GEO_ARRAY:[],init:function(){this._bindEvent(),this.startGeo({isInitGeo:!0,isNoCoverLoc:window._NO_COVER_LOC})},_bindEvent:function(){var t=this;t._hasBindEvent!==!0&&(t._hasBindEvent=!0,listener.on("common.html5Geolocation","start",function(t,o){i.init(o)}),listener.on("common.nativeGeolocation","start",function(t,o){a.init(o)}),listener.on("common.shareGeo","start",function(t,o){setTimeout(function(){s.init(o)},0)}),listener.on("common.preciseipGeo","start",function(t,o){setTimeout(function(){n.init(o)},0)}),listener.on("common.urlgeolocation","start",function(t,o){setTimeout(function(){c.init(o)},0)}),listener.on("common.geolocation","success",function(o,e){t._geoSuccess(e)}),listener.on("common.geolocation","fail",function(o,e){t._geoFail(e)}),listener.on("common.geomethod","fail",function(o,e){t._geoMethodFail(e)}),listener.on("common.geomethod","success",function(o,e){t._geoMethodSuccess(e)}))},startGeo:function(t){var o=t||{};this._IS_LAST_GEO_FAIL=!1,this._time=Date.now(),this._isInitGeo=o.isInitGeo||!1,this.sucCallback=o.success||function(){},m.start("geo",{expire:50}),m.addStat("geo","start_geo_loc"),window._NO_COVER_LOC=o.isNoCoverLoc||!1,o.isInitGeo===!0?this._checkStorageGeoStatus()&&this._checkStorageMyLocStatus()||this._startGeo({isInitGeo:!0}):this._startGeo()},_startGeo:function(){this._initGeoData(),this._GEO_METHOD_INDEX=0,this._useNextMethod()},_checkStorageGeoStatus:function(){if(window._INIT_LOC_SUC===!0){var o=t("common:widget/geolocation/location.js");return setTimeout(function(){listener.trigger("common.geolocation","success",o._location)},0),!0}return!1},_checkStorageMyLocStatus:function(){if(window._INIT_MYLOC_SUC===!0){var o=t("common:widget/geolocation/location.js");return setTimeout(function(){listener.trigger("common.geolocation","mylocsuc",o._mylocation)},0),!0}return!1},_formatToCookie:function(t){var o=t.addr||{},e=t.point||{},i=(new Date).getTime()+"",a=[];return o.accuracy=o.accuracy||1e3,o.cityCode=o.cityCode||1,e.x&&e.y&&o.cityCode?(a.push(parseInt(e.x)),a.push(parseInt(e.y)),a.push(o.accuracy),a.push(o.cityCode),a.push(i),a):void 0},_saveAddressInStorage:function(t){var o=t.addr||{},e=t.point||{},i={address:o.address,city:o.city,district:o.district,street:o.street,x:parseInt(e.x),y:parseInt(e.y)};g.addData("webapp-location-cookie",JSON.stringify(i))},_geoSuccess:function(t){var o,e=this,i=t.type,a=t.isExactPoi,s=t.isSaveLocInCookie;if(e._addStatGeoSuc(t),a&&"share"!==i&&"storage"!==i){if(s===!1)return;o=this._formatToCookie(t),this._saveAddressInStorage(t),r.save(o)}a===!0&&(e._IS_LAST_GEO_FAIL=!1),e.sucCallback&&e.sucCallback(t),e.sucCallback=null},_geoFail:function(t){var o=this;o._IS_LAST_GEO_FAIL=!0,o._addStatGeoFail(t),o.sucCallback&&(o.sucCallback=null)},_getStatTime:function(){var t=Date.now();return t=Math.ceil((t-this._time)/1e3)},_addStatGeoSuc:function(t){var o,e=this;switch(o=e._getStatTime(),t.isExactPoi&&null!=t.type&&m.addStat("geo","geo_suc_all"),t.type){case"share":5==t.minutes&&m.addStat("geo","share_geo_five_suc",{time:o}),30==t.minutes&&m.addStat("geo","share_geo_thirty_suc",{time:o});break;case"native":m.addStat("geo","native_geo_suc",{time:o});break;case"html5":m.addStat("geo","wlan_geo_success",{time:o});break;case"preciseip":m.addStat("geo","preciseip_geo_sucess",{time:o});break;case"url":m.addStat("geo","url_geo_sucess",{time:o});break;case"storage":t.isExactPoi&&m.addStat("geo","storage_geo_success",{time:o})}m.submit("geo")},_addStatGeoFail:function(t){m.addStat("geo","wlan_geo_error",{error:t.code,messgae:t.message}),m.submit("geo")},_geoMethodSuccess:function(o){var e=t("common:widget/geolocation/location.js");e.setAddress(o,this._isInitGeo),this._geoindex=0},_geoMethodFail:function(t){var o=this;o._useNextMethod(t)},_initGeoData:function(){var t={geostr:"common.nativeGeolocation",type:"start",param:{id:"first"}},o={geostr:"common.nativeGeolocation",type:"start",param:{id:"second"}},e={geostr:"common.shareGeo",type:"start",param:{par:5,id:"5min"}},i={geostr:"common.shareGeo",type:"start",param:{par:30,id:"30min"}},a={geostr:"common.preciseipGeo",type:"start",param:{}},s={geostr:"common.html5Geolocation",type:"start",param:{id:"first",par:3e4}},n={geostr:"common.html5Geolocation",type:"start",param:{id:"second",par:3e4}},c={geostr:"common.urlgeolocation",type:"start",param:{}};this._GEO_ARRAY=_.isAndroid()===!0?[c,e,t,a,s,o,i,n]:[c,e,s,a,i,n]},_useNextMethod:function(t){var o=this._GEO_ARRAY[this._GEO_METHOD_INDEX];o?(o.geostr=o.geostr||"",o.param=o.param||{},o.type=o.type||"",this._GEO_METHOD_INDEX++,listener.trigger(o.geostr,o.type,o.param)):listener.trigger("common.geolocation","fail",t)}}});