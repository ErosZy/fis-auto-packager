define("drive:widget/helper/maphelper.js",function(t,e,s){var i,o,r=t("common:static/js/util.js"),n=t("common:widget/url/url.js"),a=t("common:static/js/mapconst.js"),h=t("common:widget/appresize/appresize.js"),p=t("common:widget/stat/stat.js");$(window).on("pageshow",function(){h.update()}),s.exports={keyMarkers:[],keyPoiInfos:[],directionMarkers:[],viewOpts:{margins:a.ROUTE_MARGINS,enableAnimation:!1},_currentStep:-1,_showAll:!0,init:function(t,e,s){i=e,o=t,this.map=i.getMap(),this.renderMap(s)},renderMap:function(t){var e=n.get(),s=e.query||{},o=e.pageState||{},a=-1,h=i._clearControl,p={};r.jsonToUrl(s)+"|"+r.jsonToUrl(p),i.displayId,"undefined"!=typeof o.step&&(a=1*o.step),$.extend(p,o),delete p.vt,delete p.step,i.clearOverlays(),this.map=i.getMap(),this.removeCurrentOverlay(),this._prepareData(t),i.addDriveRoute(this.routePoints),this.addDestPoi(),this.setView(r.getBPoints(this.routeBounds)),i.getLineStepControl().show(),this.addPopInfoWin(),h&&h.resetCleanBtn(),this.selectStep(a),i.driveData=t,i._trafficControl&&(i._trafficControl.driveData=t)},addDestPoi:function(){this.startMarker=i.addDestPoi(this.destPoints[0],a.DEST_START),this.endMarker=i.addDestPoi(this.destPoints[1],a.DEST_END),$(this.startMarker._div).on("touchend",this.getClickHandler(0)),$(this.endMarker._div).on("touchend",this.getClickHandler(this.stepPoints.length-2))},selectStep:function(t){if(i.getLineStepControl().ableBtn("pre"),i.getLineStepControl().ableBtn("next"),0>=t?i.getLineStepControl().disableBtn("pre"):t>=this.stepPoints.length-2&&i.getLineStepControl().disableBtn("next"),-1==t)return this._showAll=!0,this._currentStep=0,!1;if(0>t||t>=this.stepPoints.length-1)return!1;if(t==this._currentStep){if(0==this._showAll)return this.map.setCenter(r.getPointByStr(this.stepPoints[t].p)),void 0;this._showAll=!1}var e=i._map.zoomLevel;return this._currentStep=t,i.iwController.get(a.IW_NAV).switchTo(t),this.highRoute(t),this.addDirectionMarker(t),this.showKeyPoi(t),i._map.zoomLevel<=3&&this.map.setZoom(e),!0},pre:function(){return this.selectStep(this._currentStep-1)},next:function(){return this.selectStep(this._currentStep+1)},_prepareData:function(t){this.stepPath=[],this.routePoints=[],this.stepPath=[],this.routeBounds=[],this.destPoints=[],this.stepPoints=[],this.popInfos=[];for(var e=t.content.routes[0],s=0;s<e.legs.length;s++)for(var i=e.legs[s],o=0;o<i.steps.length;o++){var n=i.steps[o],a=r.parse2Geo(n.path);this.stepPath.push(a.points),this.routeBounds.push(a.bound),this.routePoints=this.routePoints.concat(this.pointsStringToArray(a.points)),this.stepPoints.push({p:r.parse2Geo(n.start_location).points,a:i.steps[o].direction}),this.popInfos.push({content:i.steps[o].instructions}),s==e.legs.length-1&&o==i.steps.length-1&&this.stepPoints.push({p:r.parse2Geo(n.end_location).points,a:12}),n.pois.length>0&&n.pois[0]&&(this.keyPoiInfos[o]={points:r.parse2Geo(n.pois[0].location).points,title:n.pois[0].name})}this.destPoints.push(t.result.start.pt),this.destPoints.push(t.result.end[t.result.end.length-1].pt)},pointsStringToArray:function(t){var e=t.split(";"),s=[];return $.each(e,function(t,e){var i=e.split(",");s.push(new o.Point(i[0],i[1]))}),s},addPopInfoWin:function(){var t=this.stepPoints;this.popInfos,t.length;var e=i.iwController.get(a.IW_NAV);e.setData(a.IW_NAV,{json:this.popInfos,points:this.stepPoints}).switchTo(0),i.getLineStepControl().setIWCon(this),listener.on("infowindow."+a.IW_NAV,"click",function(t,e){var s=e.id;switch(s){case"iw-c":p.addCookieStat(COM_STAT_CODE.MAP_IW_NAV_LIST),n.update({pageState:{vt:"list"}},{})}})},getClickHandler:function(t){var e=this;return function(){p.addStat(COM_STAT_CODE.MAP_NAV_DIR_MARKER_CLICK),e.selectStep(t)}},swiPop:function(t,e){i.iwController.get(a.IW_NAV).switchTo(e)},highRoute:function(t){var e=this;if(e.unselectRoute(),e.routeBounds[t]){var s=[e.routeBounds[t]],i=r.getBPoints(s);e.setView(i),e.selectRoute(t)}},addDirectionMarker:function(t){for(var e=0;e<this.directionMarkers.length;e++)this.map.removeOverlay(this.directionMarkers[e]);this.directionMarkers=[];var s=i.addDirectionMarker(this.stepPoints[t].p,this.stepPoints[t].a);this.directionMarkers.push(s);var o=i.addDirectionMarker(this.stepPoints[t+1].p,this.stepPoints[t+1].a);this.directionMarkers.push(o),$(s._div).on("touchend",this.getClickHandler(t)),$(o._div).on("touchend",this.getClickHandler(t+1))},selectRoute:function(t){var e=this,s=[];s.push(e.stepPoints[t].p),s.push(e.stepPath[t]),e.redRoute=i.addDriveRoute(s.join(";")),i.selectRoute(e.redRoute)},showKeyPoi:function(t){for(var e=0;e<this.keyMarkers.length;e++)this.map.removeOverlay(this.keyMarkers[e]);this.keyMarkers=[];var s=this.keyPoiInfos[t];s&&this.keyMarkers.push(i.addKeyPoiMarker(s.points,s.title,0))},setView:function(t){i.setViewport(t,this.viewOpts)},removePoi:function(){for(var t=0;t<this.keyMarkers.length;t++)this.map.removeOverlay(this.keyMarkers[t]);this.keyMarkers=[];for(var t=0;t<this.directionMarkers.length;t++)this.map.removeOverlay(this.directionMarkers[t]);this.directionMarkers=[],this.map.removeOverlay(this.startMarker),this.map.removeOverlay(this.endMarker)},removeRoute:function(){this.redRoute&&(this.map.removeOverlay(this.redRoute),this.redRoute=null),i.removeDriveRoute()},unselectRoute:function(){this.redRoute&&(i.removeRoute(this.redRoute),this.redRoute=null)},removeCurrentOverlay:function(){i&&(this.removePoi(),this.removeRoute(),i.getLineStepControl().hide(),i.iwController.get(a.IW_NAV).hide(),i.displayId="")}}});