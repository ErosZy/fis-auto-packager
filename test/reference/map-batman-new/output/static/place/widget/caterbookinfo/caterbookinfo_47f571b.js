define("place:widget/caterbookinfo/caterbookinfo.js",function(require,exports,module){require("place:static/lib/template.js");var util=require("common:static/js/util.js"),url=require("common:widget/url/url.js"),popup=require("common:widget/popup/popup.js"),datepicker=require("common:widget/datepicker/datepicker.js"),stat=require("common:widget/stat/stat.js"),DEFAULT_ERROR_MSG="网络连接失败",USERNAME_EMPTY_MSG="姓名不能为空",TELEPHONE_ERROR_MSG="请输入正确的手机号码",DATA_TYPE="json",DETAIL_AJAX_URL="/detail?qt=cater_bookinfo",BOOK_AJAX_URL="/detail?qt=cater_bookconfirm",V_CODE_AJAX_URL="/maps/services/captcha",CODE_IMAGE="/maps/services/captcha/image?vcode=",defError=function(e){e=e||{},popup.open(e.errorMsg||DEFAULT_ERROR_MSG)},getRoomLabel=function(e,t){var a="大厅";return"1"===e&&(t=parseInt(t,10)||0,a="包间"+(t?"（"+t+"人间）":"")),a},getData=function(e,t){var a=e.split("."),i=t;if(t){for(var o=0;o<a.length&&(i=i[a[o]],i);o++);return i}},checkTel=function(e){return e&&11===e.length&&e.match(/^((\(\d{3}\))|(\d{3}\-))?13[0-9]\d{8}|15[0-9]\d{8}|18\d{9}/g)?!0:!1},CaterBookinfo=function(){var urlData=util.urlToJSON(window.location.search.replace("?",""));this.$el=$("#place-widget-caterbookinfo"),this.template=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';if(eval(_template_varName),_template_fun_array.push('<div class="message-info">    '),"1"==shop_info.discount_status&&_template_fun_array.push('        <div class="message-item" data-action="showTips" data-tips="',"undefined"==typeof shop_info.discount_info?"":baidu.template._encodeHTML(shop_info.discount_info),'">            <span class="discount"></span>            ',"undefined"==typeof shop_info.discount_info?"":baidu.template._encodeHTML(shop_info.discount_info),"        </div>    "),_template_fun_array.push("    "),"1"==shop_info.save_status&&_template_fun_array.push('        <div class="message-item" data-action="showTips" data-tips="100%保证下单十分钟内反馈，如有超时，在七日内自动补偿10元话费到订座手机号；">            <span class="save"></span>            100%保证下单十分钟内反馈，如有超时，在七日内自动补偿10元话费到订座手机号；        </div>    '),_template_fun_array.push('</div><div class="order-group date-info">    <div class="horizontal">        <div class="item vertical">            <div class="label">就餐日期</div>            <div data-action="orderDate" class="select">                <span class="select-label">                    ',"undefined"==typeof book_info.showDate?"":baidu.template._encodeHTML(book_info.showDate),"                </span>            </div>        </div>        "),book_info.ableTime&&book_info.ableTime.length){_template_fun_array.push('            <div class="item vertical">                <div class="label">就餐时间</div>                <div class="select">                    <span class="select-label">                        ',"undefined"==typeof book_info.ableTime[0]?"":baidu.template._encodeHTML(book_info.ableTime[0]),'</span>                    <select data-action="orderTime">                        ');for(var i=0;i<book_info.ableTime.length;i++)_template_fun_array.push('                            <option value="',"undefined"==typeof book_info.ableTime[i]?"":baidu.template._encodeHTML(book_info.ableTime[i]),'">                                ',"undefined"==typeof book_info.ableTime[i]?"":baidu.template._encodeHTML(book_info.ableTime[i]),"                            </option>                        ");_template_fun_array.push("                    </select>                </div>            </div>        ")}if(_template_fun_array.push('    </div>    <div class="datepicker-wrap" data-node="datepickerWrap">        <div data-node="datepicker" class="cater-datepicker"></div>    </div></div><div class="room-info">    <div class="order-group">        <div class="item">            <div class="label">                <div>人数：</div>            </div>            <div class="select">                <div data-action="orderPerson" class="main price">                    <div data-action="sub" class="minus"></div>                    <div class="num">                        <input data-action="personNum" name="number" type="number" value="1" min="1" max="50">                    </div>                    <div data-action="add" class="plus"></div>                </div>            </div>        </div>        '),"1"==book_info.room.have_room&&_template_fun_array.push('            <div class="item">                <div class="label">                    <div>席位要求：</div>                </div>                <div class="select">                    <span class="select-label">大厅</span>                    <select data-action="needRoom">                        <option value="0" selected>大厅</option>                        <option value="1">包间</option>                    </select>                </div>            </div>        '),_template_fun_array.push("    </div>    "),"1"==book_info.room.have_room){if(_template_fun_array.push('        <div class="arrow" id="arrow" style="">            <div class="arrow_border"></div>            <div class="arrow_content"></div>        </div>        <div class="choose">        '),book_info.room.detail&&book_info.room.detail.length){_template_fun_array.push('            <div>                <span class="room_type">选择包间类型</span>                <div class="splitLine"></div>                ');for(var i=0;i<book_info.room.detail.length;i++)_template_fun_array.push('                    <span data-action="roomItem" class="roomItem ',"undefined"==typeof(0===i?"yes":"")?"":baidu.template._encodeHTML(0===i?"yes":""),'" data-roomsize="10" data-mincost="100">',"undefined"==typeof book_info.room.detail[i].capacity?"":baidu.template._encodeHTML(book_info.room.detail[i].capacity),"人间（最低￥","undefined"==typeof book_info.room.detail[i].lowest_consumption?"":baidu.template._encodeHTML(book_info.room.detail[i].lowest_consumption),'）</span>                    <div class="splitLine"></div>                ');_template_fun_array.push('                <span class="room_type">                    <input type="checkbox" data-node="needHall" checked="checked">如果没有包间，也接受大厅</span>            </div>            <span class="no_room" style="display:none">.没有符合所选人数的包间</span>        ')}else _template_fun_array.push('            <span class="no_room">没有包间数据</span>        ');_template_fun_array.push("        </div>    ")}_template_fun_array.push('</div><div class="order-group">    <div class="item">        <div class="label">            <div>您贵姓：</div>        </div>        <div class="input">            <input data-node="userName" type="text" placeholder="贵姓"></div>        <div data-node="genderRadio" class="radio" data-value="0">            <div class="radio-item yes" data-action="oradioItem" data-gender="0">先生</div>            <div class="radio-item" data-action="oradioItem" data-gender="1">女士</div>        </div>    </div>    <div class="item">        <div class="label">            <div>手机号：</div>        </div>        <div class="input">            <input data-node="mobile" type="tel" placeholder="请输入您的手机号码">        </div>    </div>    </div><div class="item vcode-item">    <div class="input">        <input data-node="vcode" type="text" placeholder="请填写验证码">    </div>    <div class="vcode-img" data-action="changeVcode">        <img src="" data-node="vcodeImg">        <div class="change">换一张</div>    </div></div><div class="submit">    <div class="btn" data-action="submitOrder">提交订单</div></div>'),shop_info.agent_text&&_template_fun_array.push('    <div class="service_src">服务由',"undefined"==typeof shop_info.agent_text?"":baidu.template._encodeHTML(shop_info.agent_text),"提供</div>"),_template_fun_array.push(""),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],this.success=[function(_template_object){var _template_fun_array=[],fn=function(__data__){var _template_varName="";for(var name in __data__)_template_varName+="var "+name+'=__data__["'+name+'"];';eval(_template_varName),_template_fun_array.push('<div id="resultPage" style="display: block;">    <div class="mess_confirm">        <p>提交成功！</p>        <p class="desc" id="desc">            订单状态为“等待确认”，稍后您将收到            <br>商家确认短信，请注意查收</p>        <div class="splitLine"></div>        <p class="name">',"undefined"==typeof shop_name?"":baidu.template._encodeHTML(shop_name),"</p>        <p>","undefined"==typeof room?"":baidu.template._encodeHTML(room),"&nbsp;最低消费：","undefined"==typeof mincost?"":baidu.template._encodeHTML(mincost),"元</p>        <p>入店时间：","undefined"==typeof order_time?"":baidu.template._encodeHTML(order_time),'</p>        <p class="keepTime">最晚到店时间：',"undefined"==typeof keep_time?"":baidu.template._encodeHTML(keep_time),'</p>    </div>    <div class="goto" data-replace="true" data-action="gotoDetail" data-href="http://map.baidu.com/mobile/webapp/place/cater/force=superman&qt=orderdetail?mobile=',"undefined"==typeof mobile?"":baidu.template._encodeHTML(mobile),"&orderid=","undefined"==typeof order_id?"":baidu.template._encodeHTML(order_id),'">        查看订单详情    </div>'),agent_text&&_template_fun_array.push('    <div class="service_src">服务由',"undefined"==typeof agent_text?"":baidu.template._encodeHTML(agent_text),"提供</div>"),_template_fun_array.push("</div>"),_template_varName=null}(_template_object);return fn=null,_template_fun_array.join("")}][0],this.uid=urlData.uid,this.thirdId=urlData.thirdId,this.searchDate="",this.init()};CaterBookinfo.prototype={init:function(){this.postData={},this.getBookinfo(),this.bindEvent()},fixAbleTime:function(e){for(var t,a=[],i=0;i<e.length;i++)t=e[i],t.bookable&&a.push(t.time);return a},checkForm:function(){var e=this.$userName.val();if(!$.trim(e))return popup.open(USERNAME_EMPTY_MSG),!1;if(!checkTel(this.$mobile.val()))return popup.open(TELEPHONE_ERROR_MSG),!1;var t=this.$code.val();return $.trim(t)?!0:(popup.open("验证码不能为空"),!1)},getBookinfo:function(e){$.ajax({url:DETAIL_AJAX_URL,type:"GET",dataType:DATA_TYPE,context:this,data:{date:e||"",thirdId:this.thirdId},success:function(t){if(!t||0!==t.errorNo)return defError(t);var a=t.data;this.bookinfo=a.book_info,this.searchDate=e||a.today,this.bookinfo.showDate=this.searchDate,this.bookinfo.ableTime=this.fixAbleTime(getData("time.detail",this.bookinfo)||[]),this.shopinfo=a.shop_info,this.render(a),stat.addStat(STAT_CODE.PLACE_CATER_BOOK_INFO_PAGE_PV,{srcname:"cater",name:this.shopinfo.shop_name,agent:this.shopinfo.agent})},error:defError})},getVCode:function(){$.ajax({url:V_CODE_AJAX_URL,type:"GET",dataType:"json",context:this,success:function(e){this.vcode=e.content.vcode,this.$vcodeImg.attr("src",CODE_IMAGE+this.vcode)}})},renderSuccess:function(e){stat.addStat(STAT_CODE.PLACE_CATER_BOOK_INFO_SUCCESS_PAGE_PV,{srcname:"cater",name:this.shopinfo.shop_name,agent:this.shopinfo.agent});var t=e.data,a=1e3*parseInt(t.order_time||0,10),i=parseInt(t.keep_time||0,10);t.room=getRoomLabel(t.need_room,t.room_size),t.order_time=new Date(a).format("yyyy-MM-dd hh:mm"),t.keep_time=new Date(a+60*i*1e3).format("hh:mm"),t.mincost=t.min_cost||0,t.agent_text=t.agent_text||"",this.$el.html(this.success(t))},render:function(e){var t=this;this.$el.html(this.template(e)),this.$mobile=this.$el.find('[data-node="mobile"]'),this.$personNum=this.$el.find('[data-action="personNum"]'),this.$userName=this.$el.find('[data-node="userName"]'),this.$datepicker=this.$el.find('[data-node="datepicker"]'),this.$datepickerWrap=this.$el.find('[data-node="datepickerWrap"]'),this.$code=this.$el.find('[data-node="vcode"]'),this.$vcodeImg=this.$el.find('[data-node="vcodeImg"]'),this.$genderRadio=this.$el.find('[data-node="genderRadio"]'),this.$needHall=this.$el.find('[data-node="needHall"]'),this.$orderGroup=this.$el.find(".order-group"),this.getVCode(),this.$datepicker.datepicker({date:this.searchDate,dateList:getData("time.date_list",this.bookinfo)||[],valuecommit:function(e,a,i){t.$datepickerWrap.hide(),i!==t.searchDate&&t.getBookinfo(i)}}),this.needRoom=0,this.orderTime=getData("ableTime.0",this.bookinfo)||""},onSubmitOrderClick:function(){if(stat.addCookieStat(STAT_CODE.PLACE_CATER_BOOK_INFO_SUBMIT_CLICK,{srcname:"cater",name:this.shopinfo.shop_name,agent:this.shopinfo.agent}),this.checkForm()){var e={personNum:this.$personNum.val(),userName:this.$userName.val(),mobile:this.$mobile.val(),shopId:this.shopinfo.shop_id,bid:this.uid||"",thirdName:this.shopinfo.agent,needRoom:this.needRoom,orderTime:this.searchDate+" "+this.orderTime,code:this.$code.val(),vcode:this.vcode,from:"webapp",gender:this.$genderRadio.data("value"),acceptHall:this.$needHall[0]?this.$needHall[0].checked?1:0:1,roomSize:this.$orderGroup.data("roomsize")||""};$.ajax({url:BOOK_AJAX_URL,type:"POST",dataType:DATA_TYPE,context:this,data:e,success:function(e){return e&&0===e.errorNo?(this.renderSuccess(e),void 0):defError(e)},error:defError})}},onOrderDateClick:function(){var e="none"===this.$datepickerWrap.css("display")?"show":"hide";this.$datepickerWrap[e]()},onOrderPersonClick:function(e){var t=$(e.target),a=t.data("action"),i=parseInt(this.$personNum.val(),10);i=isNaN(i)?1:i,"add"===a?(i=Math.min(getData("person.max",this.bookinfo),i+1),this.$personNum.val(i)):"sub"===a&&(i=Math.max(getData("person.min",this.bookinfo),i-1),this.$personNum.val(i))},onOradioItemClick:function(e){var t=$(e.currentTarget),a=t.data("gender"),i=t.parents(".radio"),o=t.siblings(".radio-item");t.addClass("yes"),i.data("value",a),o.removeClass("yes")},onRoomItemClick:function(e){var t=$(e.currentTarget),a=t.data("roomsize"),i=t.data("mincost"),o=t.parents(".order-group"),n=t.siblings(".roomItem");t.addClass("yes"),o.data("roomsize",a),o.data("mincost",i),n.removeClass("yes")},onShowTipsClick:function(e){var t=$(e.currentTarget),a=t.data("tips");a&&popup.open(a)},onPersonNumBlur:function(e){var t=e.currentTarget,a=getData("person.max",this.bookinfo),i=t.value;i=parseInt(i,10)||a,t.value=Math.min(Math.max(1,i),a)},onNeedRoomChange:function(e){var t=$(e.currentTarget),a=t.siblings(".select-label"),i=t.parents(".room-info"),o=t.val();a.html("1"===o?"包间":"大厅"),i["1"===o?"addClass":"removeClass"]("has-room"),this.needRoom=o},onOrderTimeChange:function(e){var t=$(e.currentTarget),a=t.siblings(".select-label"),i=t.val();a.html(i),this.orderTime=i},onChangeVcodeClick:function(e){e.preventDefault(),this.getVCode()},onGotoDetailClick:function(e){e.stopPropagation(),stat.addCookieStat(STAT_CODE.PLACE_CATER_BOOK_INFO_GOTO_ORDER_DETAIL_CLICK,{srcname:"cater",name:this.shopinfo.shop_name,agent:this.shopinfo.agent});var t=$(e.currentTarget),a=t.data("href");url.navigate(a)},bindEvent:function(){this.$el.on("blur",'[data-action="personNum"]',$.proxy(this.onPersonNumBlur,this)),this.$el.on("change",'[data-action="needRoom"]',$.proxy(this.onNeedRoomChange,this)),this.$el.on("change",'[data-action="orderTime"]',$.proxy(this.onOrderTimeChange,this)),this.$el.on("click",'[data-action="orderPerson"]',$.proxy(this.onOrderPersonClick,this)),this.$el.on("click",'[data-action="oradioItem"]',$.proxy(this.onOradioItemClick,this)),this.$el.on("click",'[data-action="showTips"]',$.proxy(this.onShowTipsClick,this)),this.$el.on("click",'[data-action="roomItem"]',$.proxy(this.onRoomItemClick,this)),this.$el.on("click",'[data-action="orderDate"]',$.proxy(this.onOrderDateClick,this)),this.$el.on("click",'[data-action="submitOrder"]',$.proxy(this.onSubmitOrderClick,this)),this.$el.on("click",'[data-action="changeVcode"]',$.proxy(this.onChangeVcodeClick,this)),this.$el.on("click",'[data-action="gotoDetail"]',$.proxy(this.onGotoDetailClick,this))}},exports.init=function(){return new CaterBookinfo}});