define("transit:widget/helper/maphelper.js",function(t,i,s){"use strict";function e(t){var i=t.lastIndexOf("站"),s=t.length-1;return t=i===s?t:t+"站"}function n(t){var i=t.indexOf("(");return t=i>=0?t.substring(0,i):t,t+=/\D+/.test(t)?"":"路"}function o(t){var i="";return t>0&&10>=t?i="10米":t>10&&(i=1e3>t?10*(t/10).toFixed(0)+"米":(t/1e3).toFixed(1)+"公里"),i}var a,r,h=t("common:static/js/util.js"),d=t("common:static/js/mapconst.js"),u=(t("common:static/js/searchdata.js"),t("common:widget/map/map.js")),p=t("common:widget/url/url.js"),l=t("common:widget/stat/stat.js");s.exports={transPois:[],routeLines:[],sWalkLines:[],tWalkLines:[],eWalkLines:[],routeBounds:[],_index:-1,_currentStep:-1,_infoWinIndex:0,directionMarkers:[],sWalkPoint:[],tWalkPoint:[],eWalkPoint:[],sCurWalkType:[],tCurWalkType:[],eCurWalkType:[],transitRoutes:[],walkRoutes:[],busDirectionMarkers:[],lineType:[[0,2,3,4,5,6,7,9,10,11],[1,12,13,14],[8]],isEventBind:!1,init:function(t){var i=p.get(),s=(i.module,i.action,h.jsonToQuery(i.query)),e=i.pageState||{},n=1*(e.i||0);r=this.BMap=u.getBMap(),a=this.map=u.getMap(),this.initMapData(t),this.fill(n,t.content.source),this.renderMap(e,s)},initMapData:function(t){this.start=t.result.start,this.end=t.result.end,this.sWalkBounds=[],this.tWalkBounds=[],this.eWalkBounds=[],this.routeBounds=[],this.sWalkPoints=[],this.tWalkPoints=[],this.eWalkPoints=[],this.sWalkType=[],this.tWalkType=[],this.eWalkType=[],this.routePoints=[],this.transPoints=[],this.busType=[],this.stopUids=[],this.stopPois=[],this.transWins=[],this.stepIndex=[],this.clickIndex=[],this.hasSubwayLine=!1},_addStartWalk:function(t,i,s,n,a,r){var h=n[0];if(h.walk&&h.walk.distance>0){var d=h.walk,u=(h.getOff,h.getOn);r.detail.push({type:11,dis:o(d.distance),stop:e(u.name)}),this.stepIndex[t].push(0)}},_addEndWalk:function(t,i,s,n,a,r){var h=n[n.length-1];if(h&&h.walk.distance>0){var d=h.walk;r.detail.push({type:11,dis:o(d.distance),stop:e(this.end.wd)}),this.stepIndex[t].push(0)}},_eachStops:function(t,i,s){for(var o=s.stops[0],a=s.lines[0],r=0,d=o.length;d>r;r++){var u,p,l,c,f,k=o[r],W=k.walk,v=k.getOn,g=k.getOff,T=h.parse2Geo(g.geo),P=h.parse2Geo(v.geo);if(0===r){if(u=e(v.name),p=e(o[1].getOff.name),l=k.getOn&&""!==k.getOn.uid&&1===this.isStartStop?k.getOn.uid:this.start.uid,void 0===this.clickIndex[t]?(this.transPoints[t].push([T.points,g.name,-1]),this.transPoints[t].push([P.points,u,this.busType[t][r].t])):(this.transPoints[t][2*r]=[T.points,g.name,-1],this.transPoints[t][2*r+1]=[P.points,u,this.busType[t][r].t]),W&&W.geo&&W.distance>0){f=h.parse2Geo(W.geo);try{f.points+=";"+this.transPoints[t][1][0]}catch(m){}this.sWalkPoints[t].push(f.points),this.sWalkBounds[t].push(f.bound),"undefined"!=typeof W.real?this.sWalkType[t].push(W.real):this.sWalkType[t].push(-99)}this.transWins[t].push({title:this.start.wd,poi:T.points,suid:l}),this.transWins[t].push({title:u+"上车",info:"("+n(a[r].name)+")",poi:P.points,tip:a[r].tip,startTime:a[r].startTime,endTime:a[r].endTime})}if(r>0&&r<o.length-1){if(u=e(v.name),p=e(g.name),void 0===this.clickIndex[t]?(this.transPoints[t].push([T.points,p,this.busType[t][r-1].t]),this.transPoints[t].push([P.points,u,this.busType[t][r].t])):(this.transPoints[t][2*r]=[T.points,p,this.busType[t][r-1].t],this.transPoints[t][2*r+1]=[P.points,u,this.busType[t][r].t]),W&&W.geo&&W.distance>=0){f=h.parse2Geo(W.geo);try{f.points=this.transPoints[t][2*r][0]+";"+f.points+";"+this.transPoints[t][2*r+1][0]}catch(m){}this.tWalkPoints[t].push(f.points),this.tWalkBounds[t].push(f.bound),"undefined"!=typeof W.real?this.tWalkType[t].push(W.real):this.tWalkType[t].push(-99)}var y="到"+u+"上车";1===this.busType[t][r-1].t&&1===this.busType[t][r].t&&(y="换乘"+this.busType[t][r].n),this.transWins[t].push({title:p+"下车",poi:T.points}),p=e(o[r+1].getOff.name),this.transWins[t].push({title:u+"上车",poi:P.points,info:"("+n(a[r].name)+")",tip:a[r].tip,startTime:a[r].startTime,endTime:a[r].endTime})}if(r===o.length-1){if(p=e(g.name),c=k.getOff&&""!=k.getOff.uid&&1==this.isEndStop?k.getOff.uid:this.end.uid,void 0===this.clickIndex[t]&&(this.transPoints[t].push([T.points,p,this.busType[t][r-1].t]),this.transPoints[t].push([P.points,v.name,-1])),W&&W.geo&&W.distance>0){f=h.parse2Geo(W.geo);try{var I=this.transPoints[t];f.points=I[I.length-2][0]+";"+f.points}catch(m){}this.eWalkPoints[t].push(f.points),this.eWalkBounds[t].push(f.bound),"undefined"!=typeof W.real?this.eWalkType[t].push(W.real):this.eWalkType[t].push(-99)}this.transWins[t].push({title:p+"下车",poi:T.points}),this.transWins[t].push({title:this.end.wd,poi:P.points,suid:c})}}},_eachLines:function(t,i,s,a,r,d){var u=0;r.forEach(function(t){$.isPlainObject(t)&&u++});var p=r.length-u;if(10===p){d.tip=r[r.length-1];var l=r[r.length-2];try{l=l.split("T")[1],l=l.split(":"),d.arriveTime=l[0]+":"+l[1]}catch(c){d.arriveTime=""}}for(var f=0;u>f;f++)if("object"==typeof r[f]){var k=[],W=[],v=r[f],g=h.parse2Geo(v.geo),T=n(v.name),P=v.type||0,m=a[f],y=m.walk,I=m.getOn,w=m.getOff,_=a[f+1],x=_.walk,R=_.getOff,S=e(R.name),B=(x.sname||"").trim();B=B?"("+B+")":"",this.busType[t].push({t:P,n:T}),this.routePoints[t].push(g.points),this.routeBounds[t].push(g.bound),10===p&&0===f&&1===v.tip&&(d.tip=-1),1===P&&(this.hasSubwayLine=!0),void 0===this.clickIndex[t]&&(this.stopUids[t].push(v.st_uid),this.stopUids[t].push(v.ed_uid));for(var M=0,L=[],b=s.lines.length;b>M;M++){var O=s.lines[M][f],E=n(O.name),C=O.uid;M!==i&&v.uid!==C&&-1===L.indexOf(C)&&(L.push(C),k.push({i:t,r:M,l:f,n:E}),W.push(E))}if(f>0&&7>f&&(I.name!==w.name||y&&y.distance>=25)){var A={type:11,dis:o(y.distance)};1===this.busType[t][f-1].t&&1===this.busType[t][f].t?A.line=T:A.stop=e(I.name),d.detail.push(A),this.stepIndex[t].push(0)}d.title.push(T),d.detail.push({type:P,line:T,other:k,num:v.station_num,stop:S,exit:B,tip:v.tip,endTime:v.endTime,startTime:v.startTime}),this.stepIndex[t].push(1)}},fill:function(t,i){{var s=0,e=i,n=e.stops[0],o=e.lines[0],a=n.length;n[0],n[a-1]}o.forEach(function(t){$.isPlainObject(t)&&s++});var r={time:"",distance:"",title:[],detail:[],tip:0};this.sWalkBounds[t]=this.sWalkBounds[t]||[],this.tWalkBounds[t]=this.tWalkBounds[t]||[],this.eWalkBounds[t]=this.eWalkBounds[t]||[],this.routeBounds[t]=this.routeBounds[t]||[],this.sWalkPoints[t]=this.sWalkPoints[t]||[],this.tWalkPoints[t]=this.tWalkPoints[t]||[],this.eWalkPoints[t]=this.eWalkPoints[t]||[],this.sWalkType[t]=this.sWalkType[t]||[],this.tWalkType[t]=this.tWalkType[t]||[],this.eWalkType[t]=this.eWalkType[t]||[],this.routePoints[t]=this.routePoints[t]||[],this.transPoints[t]=this.transPoints[t]||[],this.busType[t]=this.busType[t]||[],this.stopUids[t]=this.stopUids[t]||[],this.stopPois[t]=this.stopPois[t]||[],this.transWins[t]=[],this.stepIndex[t]=[],this._addStartWalk(t,0,e,n,o,r),this._eachLines(t,0,e,n,o,r),this._eachStops(t,0,e,r),this._addEndWalk(t,0,e,n,o,r)},renderMap:function(t,i){t=t||{};var s=1*(t.i||0),e=-1;"undefined"!=typeof t.step&&(e=1*t.step);var n={};$.extend(n,t),delete n.vt,delete n.step;{var o=h.jsonToUrl(i)+"|"+h.jsonToUrl(n);u.displayId}this.isEventBind||(u.getMap().addEventListener("zoomend",$.proxy(this.addDirectionMarker,this)),u.getMap().addEventListener("gestureend",$.proxy(this.addDirectionMarker,this)),u.getMap().addEventListener("load",$.proxy(this.addDirectionMarker,this)),u.getMap().addEventListener("dragend",$.proxy(this.addDirectionMarker,this)),u.getMap().addEventListener("titlesend",$.proxy(this.addDirectionMarker,this)),this.isEventBind=!0),u.clearOverlays(),this.removeCurrentOverlay(),this.addPoiRoute(s,0,e),u.getLineStepControl().show(),this.setInfoWindow(s),u.displayId=o,this.selectStep(s,e)},selectStep:function(t,i){var s=u._map.zoomLevel;if(this._index=t,-1===i)return this._currentStep=0,void 0;if(!(0>i||i>this.stepIndex[t].length)){i===this.stepIndex[t].length&&this.redRoute&&u.unselectRoute(this.redRoute);var e=this.stepIndex[t][i];if(0===e){var n;n=0===i?0:i===this.stepIndex[t].length-1?2:1,this.highWalk(t,this.getWalkIndex(this.stepIndex[t],i,n),n)}1===e&&this.highRoute(t,this.getRouteIndex(this.stepIndex[t],i)),this.swiPop(t,this.getInfoWindowIndex(this.stepIndex[t],i)),this._currentStep=i,u._map.zoomLevel<=3&&this.map.setZoom(s)}},getWalkIndex:function(t,i,s){if(2===s)return 0;for(var e=0,n=0;i>n;n++)0===t[n]&&e++;return 1===s&&e--,e},getRouteIndex:function(t,i){for(var s=0,e=0;i>e;e++)1===t[e]&&s++;return s},getInfoWindowIndex:function(t,i){for(var s=0,e=0;i>=e&&(e>0&&t[e]===t[e-1]&&s++,e!==i);e++)s++;return 1===t[0]&&s++,s},pre:function(){var t=this._infoWinIndex-1;if(0>t||t>this.transWins[this._index].length-1)return!1;this.swiPop(this._index,t);var i=this.getListIndexFromInfoWinIndex(this._index,t);return this.redRoute&&u.unselectRoute(this.redRoute),-999!==i&&this.selectStep(this._index,i),!0},next:function(){var t=this._infoWinIndex+1;if(0>t||t>this.transWins[this._index].length-1)return!1;this.swiPop(this._index,t);var i=this.getListIndexFromInfoWinIndex(this._index,t);return this.redRoute&&u.unselectRoute(this.redRoute),-999!==i&&this.selectStep(this._index,i),!0},addPoiRoute:function(t,i,s){this.addLine(t,i,s),this.addPoi(t,i,s);var e,n;this.routeBounds[t]&&(e=this.routeBounds[t].concat(this.sWalkBounds[t],this.tWalkBounds[t],this.eWalkBounds[t])),n=h.getBPoints(e),n&&this.setView(n)},setInfoWindow:function(t,i){i=i?i:{};var s=(1===i.type?1:0,i.ext&&void 0!==this.tempIndex?this.tempIndex:0,this.formatTransWins(this.transWins[t]));this.getInfoWindow().setData(d.IW_BUS,{json:s.json,points:s.points}).switchTo(0),u.getLineStepControl().setIWCon(this),u.getLineStepControl().disableBtn("pre"),listener.on("infowindow."+d.IW_BUS,"click",function(t,i){var s=i.id;switch(s){case"iw-c":l.addCookieStat(COM_STAT_CODE.MAP_IW_BUS_LIST),p.update({pageState:{vt:"list"}},{})}})},formatTransWins:function(t){for(var i=[],s=[],e=0,n=t.length;n>e;e++){var o=t[e],a=o.title;o.tip&&"1"==o.tip?a=a+'<p class="iw-c-tip">首班发车'+o.startTime+"</p>":"2"==o.tip&&(a=a+'<p class="iw-c-tip">末班发车'+o.endTime+"</p>"),i.push({content:a}),s.push({p:t[e].poi})}return{json:i,points:s}},getInfoWindow:function(){return u.iwController.get(d.IW_BUS)},addPoi:function(t){var i=this,s=this.transPoints[t];if(s){var e,n,o=s.length;for(e=0,n=0;o>e;e++){var a;if(0===e)a=u.addDestPoi(s[e][0],d.DEST_START);else if(e===o-1)a=u.addDestPoi(s[e][0],d.DEST_END);else if(e>0&&o-1>e){var r=i.getLineType(s[e][2]),h=0;0===r?h=d.TRANS_TYPE_BUS:1===r?h=d.TRANS_TYPE_SUB:2==r&&(h=d.TRANS_TYPE_BUS),a=this.addTransPoi(s[e][0].toString(),h)}a&&(a._div.ontouchend=i.getClickMarker(a,t,e),i.transPois=i.transPois||[],i.transPois.push(a))}}},addTransPoi:function(t,i){var s=h.getPoiPoint(t),e=55;switch(i){case d.TRANS_TYPE_BUS:e=0;break;case d.TRANS_TYPE_SUB:e=21}var n=new r.Icon(u.DEST_MKR_PATH,new r.Size(21,21),{anchor:new r.Size(10,10),imageOffset:new r.Size(59,e)}),o=new u.CustomMarker(n,s,{className:"dest_mkr"});return a.addOverlay(o),this.transPois.push(o),o},getLineType:function(t){var i,s,e=this.lineType.length;for(i=0;e>i;i++){var n=this.lineType[i];for(s=0;s<n.length;s++){var o=n[s];if(o===t)return i}}},getClickMarker:function(t,i,s){var e=this;return function(){l.addStat(COM_STAT_CODE.MAP_BUS_DIR_MARKER_CLICK),e.map.panTo(t._point),e.swiPop(i,s,0)}},swiPop:function(t,i){var s=u.getLineStepControl();if(0===i?s.disableBtn("pre"):s.ableBtn("pre"),i>=this.transWins[t].length-1?s.disableBtn("next"):s.ableBtn("next"),!(0>i||i>this.transWins[t].length-1)){this._infoWinIndex=i;var e=this.getInfoWindow();e.switchTo(i)}},getListIndexFromInfoWinIndex:function(t,i){for(var s=0;s<this.stepIndex[t].length;s++)if(i===this.getInfoWindowIndex(this.stepIndex[t],s))return s;return-999},addLine:function(t){var i=this.routePoints[t];if(i){var s,e,n,o,a,r;for(s=0,e=i.length;e>s;s++){var h=this.addTransitRoute(i[s].toString());this.routeLines.push(h)}var d=this.sWalkPoints[t],u=this.sWalkType[t];for(this.sWalkPoint=d,this.sCurWalkType=u,s=0,n=d.length;n>s;s++)r=this.addWalkRoute(d[s].toString(),u[s]),this.sWalkLines.push(r);var p=this.tWalkPoints[t],l=this.tWalkType[t];for(this.tWalkPoint=p,this.tCurWalkType=l,s=0,o=p.length;o>s;s++)r=this.addWalkRoute(p[s].toString(),l[s]),this.tWalkLines.push(r);var c=this.eWalkPoints[t],f=this.eWalkType[t];for(this.eWalkPoint=c,this.eCurWalkType=f,s=0,a=c.length;a>s;s++)r=this.addWalkRoute(c[s].toString(),f[s]),this.eWalkLines.push(r);this.addDirectionMarker()}},addWalkRoute:function(t,i){var s;return s=1===i?u.addRoute(t,d.ROUTE_TYPE_WALK):u.addRoute(t,d.ROUTE_TYPE_UNSURE),this.walkRoutes.push(s),s},addTransitRoute:function(t){var i=u.addRoute(t,d.ROUTE_TYPE_BUS);return this.transitRoutes.push(i),i},addArrow:function(t,i){var s,e=i.CustomMarker,t=t.split(";");for(s=0;s<t.length;s++){var n=t[s].split(",");t[s]=new r.Point(n[0],n[1])}var o,h,d,u,p=-1e3,l=a.pointToPixel(t[0]);if(0!==l)for(s=0;s<t.length-1;s++){l=a.pointToPixel(t[s]);var c=a.pointToPixel(t[s+1]),f=(l.x-c.x)*(l.x-c.x)+(l.y-c.y)*(l.y-c.y);324>f||(o=Math.atan2(t[s+1].lat-t[s].lat,t[s+1].lng-t[s].lng),o-=Math.PI/2,o>0?o-=2*Math.PI:o=o,o=-o,h=22*Math.round(o/(Math.PI/8)),h!==p&&(d=new r.Icon(i.BUS_DIRECTION_PATH,new r.Size(17,17),{anchor:new r.Size(9,9),imageOffset:new r.Size(0,h)}),u=new e(d,t[s],{className:"bus_direction",enableMassClear:!1}),p=h,a.addOverlay(u),this.busDirectionMarkers.push(u)))}else for(s=0;s<t.length-1;s++)o=Math.atan2(t[s+1].lat-t[s].lat,t[s+1].lng-t[s].lng),o-=Math.PI/2,o>0?o-=2*Math.PI:o=o,o=-o,h=22*Math.round(o/(Math.PI/8)),h!==p&&(d=new r.Icon(MapView.BUS_DIRECTION_PATH,new r.Size(17,17),{anchor:new r.Size(9,9),imageOffset:new r.Size(0,h)}),u=new e(d,t[s],{className:"bus_direction",enableMassClear:!1}),p=h,a.addOverlay(u),this.busDirectionMarkers.push(u))},addDirectionMarker:function(){var t=this;try{this.removeArrowMarkers();var i,s;for(i=0,s=t.sWalkPoint.length;s>i;i++)1===t.sCurWalkType[i]&&this.addArrow(t.sWalkPoint[i],u);for(i=0;i<t.tWalkPoint.length;i++)1===t.tCurWalkType[i]&&this.addArrow(t.tWalkPoint[i],u);for(i=0,s=t.eWalkPoint.length;s>i;i++)1===t.eCurWalkType[i]&&this.addArrow(t.eWalkPoint[i],u)}catch(e){}},highRoute:function(t,i){var s=[this.routeBounds[t][i]],e=h.getBPoints(s);this.setView(e),u.unselectRoute(this.redRoute),this.routeLines&&(this.redRoute=this.routeLines[i],u.selectRoute(this.redRoute))},highWalk:function(t,i,s){this.map.enableLoadTiles=!0,u.unselectRoute(this.redRoute),this.redRoute=null;var e=[];switch(s=parseInt(s,10)){case 0:this.sWalkLines[i]&&(this.redRoute=this.sWalkLines[i],e.push(this.sWalkBounds[t][i]));break;case 1:this.tWalkLines[i]&&(this.redRoute=this.tWalkLines[i],e.push(this.tWalkBounds[t][i]));break;case 2:this.eWalkLines[i]&&(this.redRoute=this.eWalkLines[i],e.push(this.eWalkBounds[t][i]))}u.selectRoute(this.redRoute);var n=h.getBPoints(e);this.setView(n)},setView:function(t){u.setViewport(t,{margins:d.ROUTE_MARGINS,enableAnimation:!1})},removeCurrentOverlay:function(){u&&(this.removePoi(),this.removeRoute(),this.removeArrow(),u.getLineStepControl().hide(),u.displayId="",this._currentStep=-1,this._infoWinIndex=0)},removeArrowMarkers:function(){u.removeOverlayInArray(this.busDirectionMarkers)},removePoi:function(){u.removeDestPoi(),this.removeTransPoi(),this.transPois=[]},removeWalkRoute:function(){u.removeOverlayInArray(this.walkRoutes)},removeTransPoi:function(){u.removeOverlayInArray(this.transPois)},removeTransitRoute:function(){for(var t=0;t<this.transitRoutes.length;t++)u.removeRoute(this.transitRoutes[t]);this.transitRoutes=[]},removeRoute:function(){this.removeTransitRoute(),this.routeLines=[],this.removeWalkRoute(),this.sWalkLines=[],this.tWalkLines=[],this.eWalkLines=[]},removeArrow:function(){this.removeArrowMarkers(),this.sWalkPoint=[],this.tWalkPoint=[],this.eWalkPoint=[]}}});