define("place:widget/hotelthirdota/hotelthirdota.js",function(t,o,i){"use strict";function s(t){var o;t.uid&&(o={st:t.st,et:t.et,uid:t.uid},a=o,$("#place-pagelet-hotelthirdota").html('<div class="hotel-loading"><span></span><span>正在获取实时精准报价数据...</span></div>'),BigPipe.asyncLoad({id:"place-pagelet-hotelthirdota"},e.jsonToUrl(o)+"&pageletGroup=third"))}var a,e=t("common:static/js/util.js"),h=t("common:widget/geolocation/location.js"),n=t("common:widget/popup/popup.js"),l=t("common:widget/stat/stat.js");listener.on("place.datepicker","datechange",function(t,o){s(o)}),i.exports={create:function(){var t=this.$el=$("#place-pagelet-hotelthirdota");this.serverAddr="http://"+location.host+"/mobile/webapp/place/hotelbook/async=1&qt=",this.$showAllRoom=t.find(".show-all-room"),this.$showAllOta=t.find(".show-all-ota"),this.$hbMain=t.find(".main"),this.$roomsWp=t.find(".rooms"),this.$rooms=t.find(".room-list > .room-item"),this.$roomsHide=t.find(".room-list > .room-item").slice(3),this.$otasHide=t.find(".ota-list > li").slice(3),this.$otaResult=t.find(".ota-result"),this.$fetchFailed=t.find(".ota-failed"),this.$otaItem=t.find(".ota-item"),this.uid=$("#uid").html(),this.isShowAllRoom=!1,this.isShowAllOta=!1,this.lastIndex="0",this.currentIndex="0",listener.trigger("place.datepicker","showcalendar"),this.addStatParam(this.$otaResult,".ota-normal")},fetchThirdota:s,bindEvents:function(){this.bindRoomListEvents()},bindRoomListEvents:function(){this.$showAllRoom.on("click",$.proxy(this.showAllRoom,this)),this.$showAllOta.on("click",$.proxy(this.showAllOta,this)),this.$rooms.on("click",$.proxy(this.fetchOtas,this)),this.$otaItem.on("click",$.proxy(this.goToBook,this))},unbindEvents:function(){this.unbindRoomListEvents()},unbindRoomListEvents:function(){this.$showAllRoom.off("click",$.proxy(this.showAllRoom,this)),this.$showAllOta.off("click",$.proxy(this.showAllOta,this)),this.$rooms.off("click",$.proxy(this.fetchOtas,this)),this.$otaItem.off("click",$.proxy(this.goToBook,this))},showAllRoom:function(t){var o=this.$showAllRoom;o.hasClass("show-all-room-open")?(o.find("span").eq(0).html("查看其他房型"),this.$roomsHide.hide(),this.$roomsHide.find(".arrow-icon").removeClass("arrow-icon-open"),this.$roomsHide.next(".ota-result").hide()):(o.find("span").eq(0).html("收起其他房型"),this.$roomsHide.show()),l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_MOREROOM_CLICK,{uid:this.uid,type:"thirdota",from_page:_APP_HASH.action}),this.$showAllRoom.toggleClass("show-all-room-open"),t.stopPropagation(),t.stopImmediatePropagation()},showAllOta:function(t){var o=$(t.target).closest(".show-all-ota");o.hasClass("show-all-ota-open")?o.find("span").eq(0).html("展开其他报价"):o.find("span").eq(0).html("收起其他报价"),o.closest(".ota-result").find(".ota-item").slice(3).toggleClass("hide"),o.toggleClass("show-all-ota-open"),l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_MOREPRICE_CLICK,{uid:this.uid,type:"thirdota",from_page:_APP_HASH.action}),t.stopPropagation(),t.stopImmediatePropagation()},fetchOtas:function(t){var o,i,s,a,e,h=(this.$el,_APP_HASH.action),n=$(t.target).closest(".room-item").find("span").eq(1).text(),r={};l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_ROOM_CLICK,{uid:this.uid,room_type:n,from_page:h}),this.$targetRoom=$(t.target).closest(".room-item"),this.currentIndex=this.$targetRoom.attr("index"),i=this.$targetRoom.next(),s=i.hasClass("ota-result")&&i||i.children(".ota-result").length&&i.children(".ota-result"),a=this.$targetRoom.find("span").eq(0),s&&s.length?(s.toggle(),a.toggleClass("arrow-icon-open")):this.isloading||(a.toggleClass("arrow-icon-open"),e='<div class="ota-fetching"><span></span><span>正在获取实时精准报价数据...</span></div>',this.$targetRoom.after(e),this.isloading=!0,o=this.$targetRoom.attr("ota_price_url"),r={type:"POST",url:this.serverAddr+"fetchotas",data:{uid:this.uid,otaPriceUrl:o},dataType:"html"},this.fetchData(r,$.proxy(this.doFetchOtaSuccess,this),$.proxy(this.doFetchOtaError,this))),t.stopPropagation(),t.stopImmediatePropagation()},fetchData:function(t,o,i){$.ajax({type:t.type,url:t.url,data:t.data,dataType:t.dataType,success:function(t){o(t)},error:function(t,o){i(t,o)}})},doFetchOtaSuccess:function(t){this.$targetRoom.next().remove(),this.$showAllOta.off("click",$.proxy(this.showAllOta,this)),this.$targetRoom.after(t),this.$showAllOta=this.$el.find(".show-all-ota"),this.$otasHide=this.$el.find(".ota-list > li").slice(3),this.$otaItem=this.$el.find(".ota-bookbtn"),this.addStatParam(this.$targetRoom.next(),".ota-bookbtn"),this.bindEvents(),this.isloading=!1},doFetchOtaError:function(){this.bindEvents(),this.isloading=!1},doFetchRoomSuccess:function(t){var o=this.$el;this.unbindRoomListEvents(),this.$hbMain.append(t),this.$showAllRoom=o.find(".show-all-room"),this.$showAllOta=o.find(".show-all-ota"),this.$rooms=o.find(".room-list > .room-item"),this.$roomsHide=o.find(".room-list > .room-item").slice(3),this.$otasHide=o.find(".ota-list > li").slice(3),this.$roomsWp=o.find(".rooms"),this.$otaItem=o.find(".ota-item"),this.bindEvents(),this.isShowAllRoom=!1,this.isShowOta=!0,this.isShowAllOta=!1},doFetchRoomError:function(){this.bindEvents()},goToBook:function(t){var o=$(t.currentTarget),i=_APP_HASH.action,s=o.find(".ota-type").text(),a=o.find(".ota-name").text();o.hasClass("ota-web")?(l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_BOOKBTN_PC_CLICK,{uid:this.uid,type:s,ota:a,from_page:i}),n.open({text:"您好，此酒店报价需要在电脑端登陆：map.baidu.com，在酒店版块中进行搜索预订",autoCloseTime:3e3})):o.hasClass("ota-tel")&&l.addStat(STAT_CODE.PLACE_HOTEL_DETAIL_BOOKBTN_TEL_CLICK,{uid:this.uid,type:s,ota:a,from_page:i})},addStatParam:function(t,o){var i,s={from_page:_APP_HASH.action,checkin_date:a.st,checkout_date:a.et,c:h.getCityCode(),simple:1};t&&t.length&&t.find(o).each(function(){i=$(this),this.href&&(this.href=this.href+"&"+e.jsonToUrl(s))})},init:function(){var t=_APP_HASH.action;this.create(),l.addStat(STAT_CODE.PLACE_HOTEL_BOOKABLE_DETAIL_VIEW,{uid:this.uid,type:"thirdota",from_page:t}),this.bindEvents()}}});