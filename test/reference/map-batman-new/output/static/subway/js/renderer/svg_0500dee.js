var Coords=require("subway:static/js/base/coords.js"),SVG=require("subway:static/js/libs/svg.js");define("subway:static/js/renderer/svg.js",function(t,i,e){function o(){}o.supported=SVG.supported,$.extend(o.prototype,{initialize:function(t,i){this.$el=t,this.subway=i,this.container=null,this.svg=null,this.deviceWidth=$("#subway-holder").offset().width,this.deviceHeight=$("#subway-holder").offset().height,this.mapWidth=i.width,this.mapHeight=i.height,this.scaleRatio=1,this.maxScaleRatio=2,this.minScaleRatio=.2,this.scaleRate=1.25,this.zoomInRate=this.scaleRate,this.zoomOutRate=1/this.scaleRate,this.orig_x=null,this.orig_y=null,this.tolerance=16,this._createElement()},_createElement:function(){this.$el.find("#sw_renderer").remove();var t=$('<svg id="sw_svg" stlye="position: absolute" />').get(0);this.container=$('<div id="sw_renderer" style="position: relative; width: 100%; height: 100%" />'),this.$el.append(this.container.append(t)),this.svg=SVG("sw_svg").size(this.mapWidth,this.mapHeight),this.context=this.svg.group(),window.svg2=this,window.context=this.context},clear:function(){var t=this.context;t.clear()},plot:function(){this.clear(),this._plotSVG(),this._fitSVG()},_plotSVG:function(t,i,e){var o=this.context,s=this.subway;this.orig_x=void 0==t?0:t,this.orig_y=void 0==i?0:i,e=e||this.scaleRatio,this._plotMap(o,s)},_plotMap:function(t,i){var e=i.lines;t.rect(this.mapWidth,this.mapHeight).attr({fill:"none"});for(var o=0;o<e.length;o++){var s=e[o];this._plotLine(t,i,s)}for(var h=0;h<e.length;h++)for(var s=e[h],n=0;n<s.stations.length;n++){var a=s.stations[n];this._plotStation(t,i,a)}},_plotLine:function(t,i,e){t.text(e.lb).font({size:16,weight:"bold"}).fill({color:e.lc}).move(e.lbx,e.lby-16);for(var o=["M"],s=0;s<e.stations.length;s++){var h=e.stations[s],n=h.x,a=h.y,r=h.rc;if(r){var c=e.stations[s-1],l=e.stations[s+1],d=c.x,u=l.x,v=c.y,x=l.y,g=2*n-(d+u)/2,m=2*a-(v+x)/2;s>0&&o.push("Q"),o.push([g,m,u,x].join(","))}else s>0&&o.push("L"),o.push(n.toFixed(2)+","+a.toFixed(2))}e.loop&&o.push("Z"),t.path(o.join(""),!0).attr({fill:"none",stroke:e.lc,"stroke-width":8})},_plotStation:function(t,i,e){if(e.iu){if(e.icon){var o=e.icon.split(",");t.image(i.imageDataEncoded.airport,32,32).move(e.x+this._toInt(o[1]),e.y+this._toInt(o[2]))}e.ex?t.image(i.imageDataEncoded.transfer,20,20).move(e.x+e.trs_x,e.y+e.trs_y):t.circle(13).fill({color:"white"}).stroke({color:e.lc,width:2.5}).move(e.x-6.5,e.y-6.5),t.text(e.lb).font({size:16,weight:"normal"}).fill({color:"#000"}).move(e.x+e.rx,e.y+e.ry-16)}},zoomIn:function(t,i){t=t||this.deviceWidth/2,i=i||this.deviceHeight/2;var e=this.getPointFromPixel(new Coords(t,i));this.zoom(e.x,e.y,this.scaleRatio*this.zoomInRate)},zoomOut:function(t,i){t=t||this.deviceWidth/2,i=i||this.deviceHeight/2;var e=this.getPointFromPixel(new Coords(t,i));this.zoom(e.x,e.y,this.scaleRatio*this.zoomOutRate)},zoom:function(t,i,e){var o=this.context;e=Math.max(Math.min(e,this.maxScaleRatio),this.minScaleRatio),o.scale(e,e),this.scaleRatio=e,this.center(t,i)},center:function(t,i){var e=this.context;e.move(this._toPixel(-t)+this.deviceWidth/2,this._toPixel(-i)+this.deviceHeight/2),this.orig_x=e.x(),this.orig_y=e.y()},getOriginPoint:function(){return new Coords(this._toUnit(this.orig_x-this.deviceWidth/2),this._toUnit(this.orig_y-this.deviceHeight/2))},move:function(t,i){this.context,this.orig_x+t,this.orig_y+i;this._setCSSTransform(t,i,1)},moveTo:function(t,i){var e=this.context;t=this._toPixel(t)+this.deviceWidth/2,i=this._toPixel(i)+this.deviceHeight/2,e.move(t,i),this.orig_x=t,this.orig_y=i,this._clearCSSTransform()},isOutOfBounds:function(t,i,e,o){var s=t+this.getPointUnitFromPixelValue(e),h=i+this.getPointUnitFromPixelValue(o);return s>0||s<-this.mapWidth||h>0||h<-this.mapHeight?{delta_x:this.getPixelValueFromPointUnit((s>0?0:s<-this.mapWidth?-this.mapWidth:s)-t),delta_y:this.getPixelValueFromPointUnit((h>0?0:h<-this.mapHeight?-this.mapHeight:h)-i)}:!1},resize:function(t,i){if(i&&i!=this.deviceHeight){var e=this.getPointFromPixel(new Coords(this.deviceWidth/2,this.deviceHeight/2)),o=this.scaleRatio;this.deviceWidth=$("#subway-holder").offset().width,this.deviceHeight=$("#subway-holder").offset().height,this.clear(),this._plotSVG(),this.zoom(e.x,e.y,o)}},_fitSVG:function(){var t,i,e=this.deviceWidth>this.deviceHeight;e?(t=this.mapHeight,i=this.deviceHeight):(t=this.mapWidth,i=this.deviceWidth);for(var o,s,h=this.scaleRatio;t>i&&(o=h*this.zoomOutRate,s=t*this.zoomOutRate,!(o<this.minScaleRatio));)h=o,t=s;this.context.scale(h,h).center(this.deviceWidth/2,this.deviceHeight/2),this.orig_x=this.context.x(),this.orig_y=this.context.y(),this.scaleRatio=h},_setCSSTransform:function(t,i,e){(void 0==t||void 0==i)&&(t=this.orig_x||0,i=this.orig_y||0),void 0==e&&(e=1);var o=this._getTransformMatrix(t,i,e);this.container.css({transform:o,"-webkit-transform":o})},_clearCSSTransform:function(){this._setCSSTransform(0,0,1)},_getTransformMatrix:function(t,i,e){var o=[e,0,0,e,t,i];return"matrix("+o.join(",")+")"},getPointUnitFromPixelValue:function(t){return this._toUnit(t)},getPixelValueFromPointUnit:function(t){return this._toPixel(t)},getPointFromPixel:function(t){var i=this.context,e=t.x,o=t.y,s=this._toInt(this._toUnit(e-i.x())),h=this._toInt(this._toUnit(o-i.y()));return new Coords(s,h)},getPixelFromPoint:function(t){var i=this.context,e=t.x,o=t.y,s=this._toPixel(e)+i.x(),h=this._toPixel(o)+i.y();return new Coords(s,h)},isMaxScale:function(){return this.scaleRatio*this.zoomInRate>this.maxScaleRatio},isMinScale:function(){return this.scaleRatio*this.zoomOutRate<this.minScaleRatio},_toInt:function(t){return t>>0},_toUnit:function(t){return t/this.scaleRatio},_toPixel:function(t){return t*this.scaleRatio}}),e.exports=o});