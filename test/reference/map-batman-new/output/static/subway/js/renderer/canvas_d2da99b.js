var Coords=require("subway:static/js/base/coords.js");define("subway:static/js/renderer/canvas.js",function(t,i,e){function s(){}$.extend(s.prototype,{initialize:function(t,i){this.$el=t,this.subway=i,this.container=null,this.canvas=null,this.devicePixelRatio=this.getDevicePixelRatio(),this.marginRatio=0,this.deviceWidth=$("#subway-holder").offset().width,this.deviceHeight=$("#subway-holder").offset().height,this.canvasWidth=this.deviceWidth*this.devicePixelRatio*(1+2*this.marginRatio),this.canvasHeight=this.deviceHeight*this.devicePixelRatio*(1+2*this.marginRatio),this.mapWidth=i.width,this.mapHeight=i.height,this.scaleRatio=1,this.maxScaleRatio=2.4,this.minScaleRatio=.2*this.devicePixelRatio,this.scaleRate=1.25,this.zoomInRate=this.scaleRate,this.zoomOutRate=1/this.scaleRate,this.orig_x=null,this.orig_y=null,this.tolerance=20,this._createElement()},_createElement:function(){this.$el.find("#sw_renderer").remove();var t=this.canvas=document.createElement("canvas");t.width=this.canvasWidth,t.height=this.canvasHeight,t.style.position="absolute",t.style.left=this._toInt(-this.deviceWidth*this.marginRatio)+"px",t.style.top=this._toInt(-this.deviceHeight*this.marginRatio)+"px",t.style.width=this._toInt(this.deviceWidth*(1+2*this.marginRatio))+"px",t.style.height=this._toInt(this.deviceHeight*(1+2*this.marginRatio))+"px",this.container=$('<div id="sw_renderer" style="position: relative; width: 100%; height: 100%" />'),this.$el.append(this.container.append(t))},clear:function(){var t=this.canvas;if(t){var i=t.getContext("2d");i.save(),i.fillStyle="white",i.fillRect(0,0,t.width,t.height),i.restore()}},plot:function(){this._fitCanvas(),this._plotCanvas()},_plotCanvas:function(t,i,e){var s=this.canvas,a=s.getContext("2d"),h=this.subway;this.orig_x=void 0==t?-this.mapWidth/2:t,this.orig_y=void 0==i?-this.mapHeight/2:i,e=e||this.scaleRatio,this._plotMap(a,h)},_plotMap:function(t,i){this.clear(),t.save(),t.translate(0,0),t.scale(this.scaleRatio,this.scaleRatio),t.translate(this.orig_x+this._toUnit(this.canvasWidth/2),this.orig_y+this._toUnit(this.canvasHeight/2));for(var e=i.lines,s=0;s<e.length;s++)this._plotLine(t,e[s]);for(var a=0;a<e.length;a++)this._plotLineStations(t,e[a]);t.restore()},_plotLine:function(t,i){t.beginPath(),t.fillStyle=i.lc,t.font="bold 16px 微软雅黑",t.fillText(i.lb,i.lbx,i.lby);for(var e=0;e<i.stations.length;e++){var s=i.stations[e],a=s.x,h=s.y,o=s.rc;if(t.lineWidth=8,t.strokeStyle=i.lc,o){var n=i.stations[e-1],r=i.stations[e+1],l=n.x,c=r.x,d=n.y,v=r.y,g=2*a-(l+c)/2,u=2*h-(d+v)/2;t.quadraticCurveTo(g,u,c,v)}else t.lineTo(a,h);if(i.loop&&e==i.stations.length-1){var f=i.stations[0].x,m=i.stations[0].y;t.lineTo(f,m)}}t.stroke()},_plotLineStations:function(t,i){for(var e=0;e<i.stations.length;e++)this._plotStation(t,i.stations[e])},_plotStation:function(t,i){if(i.iu){if(i.icon){var e=i.icon.split(",");t.drawImage(this.subway.imageData.airport,i.x+this._toInt(e[1]),i.y+this._toInt(e[2]),32,32)}i.ex?t.drawImage(this.subway.imageData.transfer,i.x+i.trs_x,i.y+i.trs_y,20,20):(t.beginPath(),t.arc(i.x,i.y,6.5,0,2*Math.PI,!1),t.strokeStyle=i.lc,t.lineWidth=2.5,t.fillStyle="white",t.fill(),t.stroke()),t.fillStyle="black",t.font="normal 16px 微软雅黑",t.fillText(i.lb,i.x+i.rx,i.y+i.ry)}},zoomIn:function(){this.scaleRatio*=this.zoomInRate,this._plotCanvas(this.orig_x,this.orig_y)},zoomOut:function(){this.scaleRatio*=this.zoomOutRate,this._plotCanvas(this.orig_x,this.orig_y)},zoom:function(t,i,e){e=Math.max(Math.min(e,this.maxScaleRatio),this.minScaleRatio),this.scaleRatio=e,this._plotCanvas(this.orig_x,this.orig_y)},getOriginPoint:function(){return new Coords(this.orig_x,this.orig_y)},getDevicePixelRatio:function(){return window.devicePixelRatio&&window.devicePixelRatio>1?2:1},moveTo:function(t,i){this._clearCSSTransform(),this._plotCanvas(t,i,this.scaleRatio)},move:function(t,i){this._setCSSTransform(t,i)},_clearCSSTransform:function(){this._setCSSTransform(0,0,1)},_setCSSTransform:function(t,i,e){(void 0==t||void 0==i)&&(t=this.orig_x||0,i=this.orig_y||0),void 0==e&&(e=1);var s=this._getTransformMatrix(t,i,e);this.container.css({transform:s,"-webkit-transform":s})},isOutOfBounds:function(t,i,e,s){var a=t+this.getPointUnitFromPixelValue(e),h=i+this.getPointUnitFromPixelValue(s);return a>0||a<-this.mapWidth||h>0||h<-this.mapHeight?{delta_x:this.getPixelValueFromPointUnit((a>0?0:a<-this.mapWidth?-this.mapWidth:a)-t),delta_y:this.getPixelValueFromPointUnit((h>0?0:h<-this.mapHeight?-this.mapHeight:h)-i)}:!1},resize:function(t,i){if(i&&i!=this.deviceHeight){var e=this.getPointFromPixel(new Coords(this.deviceWidth/2,this.deviceHeight/2)),s=this.scaleRatio;this.deviceWidth=$("#subway-holder").offset().width,this.deviceHeight=$("#subway-holder").offset().height,this.canvas.width=this.canvasWidth=this.deviceWidth*this.devicePixelRatio*(1+2*this.marginRatio),this.canvas.height=this.canvasHeight=this.deviceHeight*this.devicePixelRatio*(1+2*this.marginRatio),this.canvas.style.width=this._toInt(this.deviceWidth*(1+2*this.marginRatio))+"px",this.canvas.style.height=this._toInt(this.deviceHeight*(1+2*this.marginRatio))+"px",this.zoom(e.x,e.y,s)}},_fitCanvas:function(){var t,i,e=this.deviceWidth>this.deviceHeight;e?(t=this.mapHeight,i=this.deviceHeight):(t=this.mapWidth,i=this.deviceWidth);for(var s,a,h=this.scaleRatio;t>i&&(s=h*this.zoomOutRate,a=t*this.zoomOutRate,!(s<this.minScaleRatio));)h=s,t=a;this.scaleRatio=h},_getTransformMatrix:function(t,i,e){var s=[e,0,0,e,t,i];return"matrix("+s.join(",")+")"},getPointUnitFromPixelValue:function(t){return this._toUnit(t*this.devicePixelRatio)},getPixelValueFromPointUnit:function(t){return this._toPixel(t)/this.devicePixelRatio},getPointFromPixel:function(t){var i=t.x*this.devicePixelRatio,e=t.y*this.devicePixelRatio;if(!(0>i||0>e||i>this.mapWidth||e>this.mapHeight)){var s=this._toInt(this._toUnit(i-this.canvasWidth/2)-this.orig_x),a=this._toInt(this._toUnit(e-this.canvasHeight/2)-this.orig_y);return new Coords(s,a)}},getPixelFromPoint:function(t){var i=t.x+this.orig_x,e=t.y+this.orig_y,s=(this._toPixel(i)+this.canvasWidth/2/(1+2*this.marginRatio))/this.devicePixelRatio,a=(this._toPixel(e)+this.canvasHeight/2/(1+2*this.marginRatio))/this.devicePixelRatio;return new Coords(s,a)},isMaxScale:function(){return this.scaleRatio*this.zoomInRate>this.maxScaleRatio},isMinScale:function(){return this.scaleRatio*this.zoomOutRate<this.minScaleRatio},_toInt:function(t){return t>>0},_toUnit:function(t){return t/this.scaleRatio},_toPixel:function(t){return t*this.scaleRatio}}),e.exports=s});