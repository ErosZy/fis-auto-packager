define("place:widget/genericre/genericre-tiles.js",function(t,e,i){function s(){this.json=null,this.qWord="",this.qCity=-1,this.isGRequest=!1,this.genDataLst={},this.genDataIdLis=[],this.spotOnId="",this.marker=null,this.curBoundTiles=[],this.curCenterPoint=null,this.types={36:{t:1},38:{t:1},39:{t:1}}}var n=t("common:static/js/mapconst.js"),a=t("common:static/js/util.js"),r=t("common:widget/geolocation/location.js"),o=t("common:static/js/searchdata.js"),h=t("place:widget/genericlayer/genericlayer.js");$.extend(s.prototype,{initialize:function(){this.clearCache()},setMapView:function(t){this.mapView=t,this.map=t.getMap(),this.bindSpotClickEvent()},bindSpotClickEvent:function(){var t=this;if(!this.binded){this.binded=!0;var e=function(e){var i=t.mapView.iwController.get();if(!i.skipClickHandler){var s=e.spots;if(!s||s.length<1||!s[0].getUserData().tag||"GR_DATA"!=s[0].getUserData().tag)return t.marker&&(t.map.removeOverlay(t.marker),t.marker=null),void 0;t.onGRHotspotClick&&t.onGRHotspotClick(e);var n=s[0].getUserData().userdata,a=n.uid,r=n.name;t.showPoiInfoWindow(s[0].getPosition(),a,r)}};listener.on("infowindow."+n.IW_GRT,"click",function(t,e){var i=e.id,s=e.data,n=e.instance;switch(i){case"iw-l":n.nbSearch(s.name,s.geo);break;case"iw-c":n.detailSearch(s.uid);break;case"iw-r":n.lineSearch(s.name,s.geo)}}),this.map.addEventListener("onhotspotclick",e)}},setGRData:function(t){t&&(this.json=t,this.clearListener(),this.resetStatus())},resetStatus:function(){var t=this.json.result.type.toString();this.types[t]&&(this.isGRequest=!0,1==this.types[t].t?(this.addGRMap(),this.addMDRequest()):2==this.types[t].t&&(this.clearGRMap(),this.clearListener()),this.addMDEvent(),this.curCenterPoint=this.map.centerPoint)},clearCache:function(){this.isGRequest=!1,this.genDataLst={},this.genDataIdLis=[],this.spotOnId="",this.curBoundTiles=[],this.marker&&(this.map.removeOverlay(this.marker),this.marker=null),this.clearListener(),this.map.clearHotspots(),this.qWord="",this.qCity=-1,this.clearGRMap()},clearListener:function(){this.map&&(this.map.removeEventListener("load",window.bindMDRequest),this.map.removeEventListener("moveend",window.bindMDRequest),this.map.removeEventListener("zoomend",window.bindMDRequest),this.map.removeEventListener("mapcontainerresize",window.bindMDRequest))},clearGRMap:function(){var t=s.MDLayer;t&&(this.map.removeTileLayer(t),this.qWord="",this.qCity=-1,this.genDataLst={},this.genDataIdLis=[]),s.MDLayer=null,this.marker&&this.marker.hide()},addGRMap:function(){if(this.json){var t=this.json.result.return_query||"";if(this.qWord!=t||this.qCity!=r.getCityCode()){if(this.clearGRMap(),38==this.json.result.type&&this.map.zoomLevel<11)return;this.qWord=t,this.qCity=r.getCityCode().cityCode;var e=(new BMap.Bounds(-21364736,-10616832,23855104,15859712),new h({json:this.json,transparentPng:!1}));this.map.addTileLayer(e),s.MDLayer=e}}},sendMDRequest:function(){var t=this;setTimeout(function(){t._sendMDRequest()},1)},_sendMDRequest:function(){var t=this;if(t.json&&t.isGRequest){var e=this.map.getViewTiles(),i=[];this.curBoundTiles=[];for(var s=0,n=e.length;n>s;s++){var a=this.map.getZoom()+"_"+e[s].x+"_"+e[s].y;this.curBoundTiles.push(a),t.genDataLst[a]||i.push(e[s].x+"_"+e[s].y)}if(0!=i.length){this.map.clearHotspots();var o=[];o.push("/?qt="),o.push("bkg_data&c="+r.getCityCode()+"&ie=utf-8&wd="+encodeURIComponent(t.json.result.return_query)),window.placeParam&&o.push(window.placeParam),o.push("&rn=4");var h=this.map.getBounds(),d="("+h.getSouthWest().lng+","+h.getSouthWest().lat+";"+h.getNorthEast().lng+","+h.getNorthEast().lat+")";o.push("&l="+this.map.zoomLevel+"&xy="+i.join(",")+"&callback=getMData&b="+d),$.ajaxJSONP({url:o.join("")})}}},addMDRequest:function(){this.sendMDRequest()},showPoiInfoWindow:function(t,e,i){t&&e&&i&&(t=new BMap.Point(t.lng,t.lat),this.marker?this.marker.setPoint(t):this.marker=this.addGRMarker(t),this.marker.show(),iwOverlay=this.mapView.iwController.get(n.IW_GRT),iwOverlay.setData(n.IW_GRT,{json:{uid:e,name:i,geo:"1|"+t.lng+","+t.lat}}).switchTo(0),iwOverlay.skipClickHandler=!0)},addGRMarker:function(t){var e=new BMap.Icon(n.MARKERS_PATH,new BMap.Size(23,32),{anchor:new BMap.Size(12,32),imageOffset:new BMap.Size(29,352)}),i=new this.mapView.CustomMarker(e,t,{className:"fix_gr_mk"});return this.map.addOverlay(i),i},sendInfRequest:function(t){if(t){var e=this,i="qt=inf&uid="+t;o.fetch(i,function(i){var s=i.content,n=a.getPointByStr(a.parseGeo(s.geo).points);e.showPoiInfoWindow(n,t,s.name)})}},getGRData:function(t){if(t){for(var e=0,i=t.length;i>e;e++){for(var s=[],n=t[e],a=0,r=n.uids.length;r>a;a++)s.push({pt:new BMap.Point(n.uids[a].x,n.uids[a].y),bd:[30,16,0,16],userdata:{name:n.uids[a].name,uid:n.uids[a].uid},tag:"GR_DATA"});if(this.genDataLst[n.tileid]=s,this.genDataIdLis.push(n.tileid.toString()),this.genDataIdLis.length>30){var o=this.genDataIdLis.shift();delete this.genDataLst[o],delete o}}for(var e=0,i=this.curBoundTiles.length;i>e;e++)if(this.genDataLst[this.curBoundTiles[e]])for(var h=this.genDataLst[this.curBoundTiles[e]],a=0,r=h.length;r>a;a++){var d=new BMap.Hotspot(h[a].pt,{userData:h[a],offsets:h[a].bd});this.map.addHotspot(d)}}},hasNotMoved:function(){if(!this.curCenterPoint)return!0;0===this.curCenterPoint.lng&&0===this.curCenterPoint.lat&&(this.curCenterPoint=this.map.centerPoint);var t=this.map.pointToPixel(this.curCenterPoint),e=this.map.pointToPixel(this.map.centerPoint),i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y);return this.curCenterPoint=this.map.centerPoint,i>=.6*this.map.width||s>=.6*this.map.height?!1:!0},addMDEvent:function(){var t=this;window.bindMDRequest||(window.bindMDRequest=function(e){"onmoveend"===e.type&&t.hasNotMoved()||t.sendMDRequest()}),this.map.addEventListener("load",window.bindMDRequest),this.map.addEventListener("moveend",window.bindMDRequest),this.map.addEventListener("zoomend",window.bindMDRequest),this.map.addEventListener("mapcontainerresize",window.bindMDRequest)}}),window.getMData=function(e){if(e){var i=t("place:widget/genericrequest/genericrequest.js");i.getGRData(e)}},i.exports=new s});