define("taxi:widget/vip/home/home.js",function(t,i,n){"use strict";t("common:static/js/gmu/src/widget/suggestion/suggestion.js"),t("common:static/js/gmu/src/widget/suggestion/renderlist.js"),t("common:static/js/gmu/src/widget/suggestion/sendrequest.js");var e=t("common:static/js/util.js"),o=t("taxi:static/js/storage.js"),a=t("common:widget/geolocation/geolocation.js"),r=t("taxi:widget/common/popup/popup.js"),s=t("taxi:widget/common/addprice/addprice.js"),c=t("common:widget/stat/stat.js"),i={create:function(){var t=this,i=$(".taxi-widget-vip-home"),n=i.find(".btn-submit"),e=i.find(".nearby-car-info"),o=i.find(".add-price"),a=i.find("input[name=route_start]"),r=i.find("input[name=route_end]"),s=i.find("input[name=phone]"),c=i.find(".home"),d=i.find(".input-panel"),u=i.find(".btn-back-to-form"),l=i.find(".btn-confirm"),p=i.find(".home .input-wrapper"),f=i.find(".btn-orderlist"),h=i.find(".btn-register");n.on("click",$.proxy(this.onBtnSubmitClick,this)),u.on("click",$.proxy(this.onBtnBackToFormClick,this)),l.on("click",$.proxy(this.onBtnConfirmClick,this)),f.on("click",$.proxy(this.onBtnOrderlistClick,this)),h.on("click",$.proxy(this.onBtnRegisterClick,this)),p.on("click",$.proxy(this.onFormInputClick,this)),listener.on("common.geolocation","success",function(i,n){t.onGeoSuccess(n)}),listener.on("common.geolocation","fail",$.proxy(this.onGeoFail,this)),this.suggestion=new gmu.Suggestion("#sug-target",{source:"http://map.baidu.com/su",cbKey:"callback",listCount:4,appendContanier:".input-panel",historyShare:!1,quickdelete:!1}),this.suggestion.on("select",$.proxy(this.onBtnConfirmClick,this)),this.$el=i,this.$nearbyCarInfo=e,this.$addPrice=o,this.$btnSubmit=n,this.$form=c,this.$inputPanel=d,this.$routeStart=a,this.$routeEnd=r,this.$phone=s},onBtnSubmitClick:function(){var t,i=this.verifyInput(),n=e.urlToJSON(this.$el.find("form").serialize());if(!this.geoSuccess)return r.open({text:"定位不成功，不能发起打车请求！",layer:!0}),!1;if(!this.getNearbyCarInfoSuccess)return r.open({text:"获取附近车辆信息失败，请稍后再试！",layer:!0}),!1;if(n.phone||(n.phone=n.third_phone),0>i){switch(i){case-1:t="客人电话号码格式错误！";break;case-2:t="请输入起点!";break;case-3:t="请输入终点!"}return r.open({text:t,layer:!0}),!1}this.submit(n)},submit:function(t){r.open({text:"正在发送打车请求...",layer:!0,autoCloseTime:0}),LoadManager.request({data:t,success:function(i){o.set("orderId",i.info.order_id),o.set("orderStartTime",Date.now()),r.open({text:"订单发送成功！",layer:!0}),c.addStat(STAT_CODE.TAXI_USERREQ,{addPrice:t.add_price})},error:function(t){var i="";switch(t.errno){case-121:i="发单太频繁，请稍后再试！";break;case-101:i="请求参数错误！";break;default:i="系统错误！"}r.open({text:i,layer:!0})}})},onFormInputClick:function(t){var i=$(t.currentTarget).find("input"),n=i.attr("name");this.$form.hide(),this.$inputPanel.show(),this.$inputPanel.attr("data-type",n),this.$inputPanel.find(".poi-input").val(i.val()).focus()},onBtnBackToFormClick:function(){this.backToForm()},onBtnConfirmClick:function(){var t=this.$inputPanel.attr("data-type");this.$el.find("input[name="+t+"]").val(this.$inputPanel.find(".poi-input").val()),this.backToForm()},onBtnOrderlistClick:function(){LoadManager.loadPage("vip/orderlist")},onBtnRegisterClick:function(){LoadManager.loadPage("vip/verify",{referrer:"vip/home"})},backToForm:function(){this.$inputPanel.find(".poi-input").val(""),this.$inputPanel.hide(),this.$form.show()},onGeoSuccess:function(t){var i,n=parseInt(t.addr.cityCode,10);this.cityList.indexOf(n)>-1?(this.getNearByCarInfo(t.point.x,t.point.y,n),i=t.addr,i=i.address||i.city+i.district+i.street,this.$routeStart.val(i),o.set("cityCode",n)):r.open({text:"当前城市不支持打车！",layer:!0}),this.geoSuccess=!0},onGeoFail:function(){r.open({text:"定位失败\n请检查定位服务，以便将打车请求发您周边的司机!",layer:!0}),this.geoFail=!0},verifyInput:function(){var t=this.$routeStart.val(),i=this.$routeEnd.val(),n=this.$phone.val();return n&&!Taxi.validatePhone(n)?-1:t?i?!0:-3:-2},getNearByCarInfo:function(t,i,n){var e=this,a=this.$nearbyCarInfo;LoadManager.request({data:{qt:"nearby",lng:t,lat:i,city_code:n},success:function(r){var c,d=e.$el;a.addClass("loaded").find(".count").text(r.info.taxi_num),r.info.is_add_price&&1===r.info.is_add_price.flag&&(c=r.info.is_add_price.price_list)&&(c=c.split(":"),s.init(c),d.find("[type=input][name=add_price]").remove()),d.find("[name=taxi_num]").val(r.info.taxi_num),d.find("[name=lng]").val(t),d.find("[name=lat]").val(i),d.find("[name=city_code]").val(n),d.find("[name=price_list]").val(c),d.find("[name=third_phone]").val(o.get("thirdPhone")),e.getNearbyCarInfoSuccess=!0},error:function(t){var i="";switch(t.errno){case-105:i="当前城市不支持打车！";break;default:i="系统错误！"}r.open({text:i,layer:!0})}})},getCityList:function(t){var i=this;LoadManager.request({data:{qt:"citylist",city_list:"all"},success:function(n){i.cityList=n.info,t()},error:function(t){var i="";switch(t.errno){case-101:i="参数错误！";break;default:i="系统错误！"}r.open({text:i,layer:!0})}})},destroy:function(){},init:function(){this.create(),this.getCityList($.proxy(a.init,a))}};n.exports=i});