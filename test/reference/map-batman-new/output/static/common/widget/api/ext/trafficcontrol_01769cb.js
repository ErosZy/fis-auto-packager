define("common:widget/api/ext/trafficcontrol.js",function(t,e,i){var n=t("common:static/js/util.js"),a=t("common:widget/popup/popup.js"),o=t("common:widget/url/url.js"),s=t("common:static/js/mapconst.js"),r=(t("common:widget/geolocation/location.js"),t("common:widget/stat/stat.js")),c=function(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,n.isIPad()?(this.defaultAnchor=BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=new BMap.Size(16,16)):this.defaultOffset=new BMap.Size(8,160),this.isOn=!1,this.trafficLayer=null,this.PAGE_ID="traffic_map",this.trafficStorageKey="_traffic_status"};c.prototype=new BMap.Control,$.extend(c.prototype,{initialize:function(e){this._map=e;var i=document.createElement("div");i.className="tf_btn tf_close",i.innerHTML='<div class="btn_bg">                            <span class="tf_icon"></span>                        </div>',e.getContainer().appendChild(i),this._node=$(i);var n=this;this._node.on("click",function(t){n.toggleTraffic.call(n,t),this.blur()}),n.resetStatus(),e.addEventListener("zoomend",function(){n.resetStatus()}),e.addEventListener("gestureend",function(){setTimeout(function(){n.resetStatus()},80)}),e.addEventListener("load",function(){n.resetStatus()}),e.addEventListener("touchend",function(){e.lastLevel!=e.zoomLevel&&n.isOn}),e.addEventListener("dragend",function(){if(n.isOn){var t=function(){clearTimeout(n.eventTimeout),n.eventTimeout=null};setTimeout(function(){t(),setTimeout(function(){t()},200)},500)}});{var a=o.get();a.pageState,t("common:widget/map/map.js")}return listener.on("common.map","addlazycontrol",function(){n.isTurnOnPageState()&&n.turnOnTraffic()}),i},isTurnOnPageState:function(){var t=o.get(),e=t.pageState;if(e&&"on"===e.traffic)return!0;try{var i=localStorage.getItem(this.trafficStorageKey);if("1"===i)return!0}catch(n){}},toggleTraffic:function(){this.isOn?this.turnOffTraffic():this.turnOnTraffic()},turnOnTraffic:function(){this.isOn||r.addStat(COM_STAT_CODE.MAP_TRAFFIC_ICON_ON),this._node.removeClass("tf_close"),this._node.addClass("tf_on"),this._addTrafficLayer(),n.need2ShowTraffic()||"third"===window._APP_HASH.module&&"traffic"===window._APP_HASH.action?this.isOn||r.addStat(COM_STAT_CODE.MAP_TRAFFIC_ON_PV):(this._showTips(),this.hide()),this.isOn=!0,this.initTrafficEvents();try{localStorage.setItem(this.trafficStorageKey,"1")}catch(t){}o.update({pageState:{traffic:"on"}},{replace:!0,trigger:!1})},turnOffTraffic:function(){this.isOn&&r.addStat(COM_STAT_CODE.MAP_TRAFFIC_ICON_OFF),this._node.removeClass("tf_on"),this._node.addClass("tf_close"),n.need2ShowTraffic()&&0!=this.isOn&&r.addStat(COM_STAT_CODE.MAP_TRAFFIC_OFF_PV);try{localStorage.removeItem(this.trafficStorageKey)}catch(t){}o.update({pageState:{traffic:"off"}},{replace:!0,trigger:!1}),this._removeTrafficLayer(),this.isOn=!1},initTrafficEvents:function(){var t=this._map.getZoom();9>=t||!this.isOn?this.removeTrafficEvents():!this.eventTimeout&&this.isOn&&this._getTrafficEvents($.proxy(this._onTrafficEventsHandler,this))},_onTrafficEventsHandler:function(t){-1!=t.result&&this.addTrafficEvents(t.content||[]),this.eventTimeout||(this.eventTimeout=setTimeout($.proxy(function(){this._getTrafficEvents($.proxy(this._onTrafficEventsHandler,this))},this),3e5))},_getCityByBounds:function(t){var e=document.getElementsByTagName("HEAD")[0],i=this._map.getBounds(),a=this._map.getZoom(),o={newmap:1,qt:"cen",b:i._neLng+","+i._neLat+";"+i._swLng+","+i._swLat,l:a},r=s.CITY_BY_BOUNDS_URI+"?"+n.jsonToQuery(o),c=document.createElement("script");c.type="text/javascript",c.src=r,e.appendChild(c),c.onload=function(){t&&t(_mapCenter||{}),e.removeChild(c),c.onload=null}},_getTrafficEvents:function(t){var e=document.getElementsByTagName("HEAD")[0],i=this;window.Instance=function(){return this.trafficDataModel={},this.trafficDataModel.setData=function(t){this.data=t},trafficDataModel};var a={qt:"traeve_data",call_back:"HANDER_TRAFFIC_DATA"};this._getCityByBounds(function(o){var r=o.current_city?o.current_city.code:location.getCityCode(),c=[];if(i.lastCityCode===r)return t&&t(trafficDataModel.data),void 0;i.lastCityCode=r,i.removeTrafficEvents(),c.push($.extend({time:Date.now(),t:Date.now(),city_code:r},a));try{}catch(f){console.log(f.message)}c.forEach(function(i){var a=s.TRAFIIC_URI+"?"+n.jsonToQuery(i),o=document.createElement("script");o.type="text/javascript",o.src=a,e.appendChild(o),o.onload=function(){t&&t(trafficDataModel.data),e.removeChild(o),o.onload=null}})})},getIconByType:function(t){var e="/static/common/images/trf_evt_04682c9.png",i=0;switch(t){case"1":i=110;break;case"2":i=83;break;case"3":i=0;break;case"5":i=51;break;case"6":i=24;break;case"8":i=134;break;default:i="0"}var n=new BMap.Icon(e,new BMap.Size(28,28),{anchor:new BMap.Size(14,28),imageOffset:new BMap.Size(-1,i)});return n},addTrafficEvents:function(e){var i=t("common:widget/map/map.js"),n=i.getCustomMarker(),a=this;a.eventMarkers=a.eventMarkers||[];var o=function(t){a.dispatchEvent("click",{data:t})};e.forEach(function(t){var e=t.geo.split(","),i=e[0].indexOf("|")?e[0].split("|")[1]:e[0],s=new BMap.Point(i,e[1]);t.point=s;var r=new n(a.getIconByType(t.type),s,{className:"events_mrk",click:function(t){return function(){o.call(this,t)}}(t)});a._map.addOverlay(r),a.eventMarkers.push(r)})},removeTrafficEvents:function(){this.eventMarkers=this.eventMarkers||[],this.eventMarkers.forEach($.proxy(function(t){this._map.removeOverlay(t)},this)),this.eventMarkers.length=0,clearTimeout(this.eventTimeout),this.eventTimeout=null,this.dispatchEvent("remove")},_addTrafficLayer:function(){this._map.setTrafficOn()},_removeTrafficLayer:function(){this._map.setTrafficOff(),this.removeTrafficEvents()},_showTips:function(){var t=this._map,e=t.getZoom(),i=o.get().pageState.vt,n=window._APP_HASH;e>9&&("map"==i||/map/i.test(n.page))&&(r.addStat(COM_STAT_CODE.MAP_TRAFFIC_TIPS),a.open({text:"当前城市暂无实时路况数据"}))},resetStatus:function(){this._ifShow()?this.show():this.hide()},_ifShow:function(){return this._map.getZoom()>5&&n.need2ShowTraffic()?!0:!1},hide:function(){$(".tf_btn").hide()},show:function(){$(".tf_btn").show()},update:function(){var t=o.get().pageState;n.need2ShowTraffic()?(this.show(),t&&"on"===t.traffic&&this._getTrafficEvents($.proxy(this._onTrafficEventsHandler,this))):(t&&"on"===t.traffic&&this._showTips(),this.hide())}}),c._className_="TrafficControl",i.exports=c});