define("taxi:widget/home/home.js",function(t,i,n){"use strict";t("common:static/js/gmu/src/widget/suggestion/suggestion.js"),t("common:static/js/gmu/src/widget/suggestion/renderlist.js"),t("common:static/js/gmu/src/widget/suggestion/sendrequest.js");var e=t("common:static/js/util.js"),o=t("taxi:static/js/storage.js"),a=t("common:widget/geolocation/geolocation.js"),s=t("taxi:widget/common/popup/popup.js"),r=t("taxi:widget/common/addprice/addprice.js"),c=t("taxi:widget/common/taxirequester/taxirequester.js"),i={create:function(){var t=this,i=$(".taxi-widget-home"),n=i.find(".btn-submit"),e=i.find(".nearby-car-info"),o=i.find(".add-price"),a=i.find("input[name=route_start]"),s=i.find("input[name=route_end]"),r=i.find(".home"),c=i.find(".input-panel"),u=i.find(".btn-back"),l=i.find(".btn-back-to-form"),d=i.find(".btn-settings"),f=i.find(".btn-confirm"),p=i.find(".home .input-wrapper");document.referrer&&(u.show(),u.on("click",$.proxy(this.onBtnBackClick,this))),n.on("click",$.proxy(this.onBtnSubmitClick,this)),l.on("click",$.proxy(this.onBtnBackToFormClick,this)),f.on("click",$.proxy(this.onBtnConfirmClick,this)),d.on("click",$.proxy(this.onBtnSettingsClick,this)),p.on("click",$.proxy(this.onFormInputClick,this)),listener.on("common.geolocation","success",function(i,n){t.onGeoSuccess(n)}),listener.on("common.geolocation","fail",$.proxy(this.onGeoFail,this)),this.suggestion=new gmu.Suggestion(".poi-input",{source:"http://map.baidu.com/su",cbKey:"callback",listCount:4,appendContanier:".input-panel",historyShare:!1,quickdelete:!1}),this.suggestion.on("select",$.proxy(this.onBtnConfirmClick,this)),this.$el=i,this.$nearbyCarInfo=e,this.$addPrice=o,this.$btnSubmit=n,this.$form=r,this.$inputPanel=c,this.$routeStart=a,this.$routeEnd=s},onBtnSubmitClick:function(){var t=this.verifyInput(),i=e.urlToJSON(this.$el.find("form").serialize());if(!this.geoSuccess)return s.open({text:"定位不成功，不能发起打车请求！",layer:!0}),!1;if(!this.getNearbyCarInfoSuccess)return s.open({text:"获取附近车辆信息失败，请稍后再试！",layer:!0}),!1;if(0>t){switch(t){case-1:LoadManager.loadPage("verify",$.extend({},i,{referrer:"home"}));break;case-2:s.open({text:"请输入起点!",layer:!0});break;case-3:s.open({text:"请输入终点!",layer:!0})}return!1}c.request(e.urlToJSON(this.$el.find("form").serialize()))},onFormInputClick:function(t){var i=$(t.currentTarget).find("input"),n=i.attr("name");this.$form.hide(),this.$inputPanel.show(),this.$inputPanel.attr("data-type",n),this.$inputPanel.find(".poi-input").val(i.val()).focus()},onBtnSettingsClick:function(){var t=o.get("phone");t?LoadManager.loadPage("settings"):LoadManager.loadPage("verify")},onBtnBackToFormClick:function(){this.backToForm()},onBtnConfirmClick:function(){var t=this.$inputPanel.attr("data-type");this.$el.find("input[name="+t+"]").val(this.$inputPanel.find(".poi-input").val()),this.backToForm()},backToForm:function(){this.$inputPanel.find(".poi-input").val(""),this.$inputPanel.hide(),this.$form.show()},onGeoSuccess:function(t){var i,n=parseInt(t.addr.cityCode,10);this.cityList.indexOf(n)>-1?(this.getNearByCarInfo(t.point.x,t.point.y,n),i=t.addr,i=i.address||i.city+i.district+i.street,this.$routeStart.val(i)):s.open({text:"当前城市不支持打车！",layer:!0}),this.geoSuccess=!0},onGeoFail:function(){s.open({text:"定位失败\n请检查定位服务，以便将打车请求发您周边的司机!",layer:!0}),this.geoFail=!0},verifyInput:function(){var t=o.get("phone"),i=this.$routeStart.val(),n=this.$routeEnd.val();return i?n?t?!0:-1:-3:-2},getNearByCarInfo:function(t,i,n){var e=this,a=this.$nearbyCarInfo;LoadManager.request({data:{qt:"nearby",lng:t,lat:i,city_code:n},success:function(s){var c,u=e.$el;a.addClass("loaded").find(".count").text(s.info.taxi_num),s.info.is_add_price&&1===s.info.is_add_price.flag&&(c=s.info.is_add_price.price_list)&&(c=c.split(":"),r.init(c),u.find("[type=input][name=add_price]").remove()),u.find("[name=taxi_num]").val(s.info.taxi_num),u.find("[name=lng]").val(t),u.find("[name=lat]").val(i),u.find("[name=city_code]").val(n),u.find("[name=price_list]").val(c),u.find("[name=phone]").val(o.get("phone")),e.getNearbyCarInfoSuccess=!0},error:function(t){var i="";switch(t.errno){case-105:i="当前城市不支持打车！";break;default:i="系统错误！"}s.open({text:i,layer:!0})}})},getCityList:function(t){var i=this;LoadManager.request({data:{qt:"citylist",city_list:"all"},success:function(n){i.cityList=n.info,t()},error:function(t){var i="";switch(t.errno){case-101:i="参数错误！";break;default:i="系统错误！"}s.open({text:i,layer:!0})}})},onBtnBackClick:function(){history.back()},destroy:function(){},init:function(){this.create(),this.getCityList($.proxy(a.init,a))}};n.exports=i});