define("subway:widget/subway/subway.js",function(e,t,i){var n=e("common:widget/url/url.js"),o=e("common:widget/appresize/appresize.js"),r=e("subway:static/js/libs/hammer.js"),s=e("subway:static/js/model/subway.js"),a=e("common:widget/stat/stat.js");i.exports=$.extend({},{subway:null,renderer:null,init:function(e){o.update();var t=this.$parent=$("#main"),i=t.height();t.children().each(function(){i-=$(this).height()}),this.$el=$("#subway-holder"),this.$el.css({height:i,visibility:"hidden"}).show(),this.params=n.get(),this.initHammer(),this.render(e),this.bind(),this.initCenterLocation()},render:function(e){this.subway=e;var t=this.renderer=this._getRenderer();t.initialize(this.$el,e),s.onresourceload?t.plot():listener.once("subway","onresourceload",function(){t.plot()})},_getRenderer:function(){var t,i=this.params;return i&&i.pageState&&"canvas"===i.pageState.force?(t=e("subway:static/js/renderer/canvas.js"),new t):(t=this._isSupportSVG()?e("subway:static/js/renderer/svg.js"):e("subway:static/js/renderer/canvas.js"),new t)},_isSupportSVG:function(){return!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect},initHammer:function(){var e=this,t=this.$el.get(0);this.hammer&&(this.hammer.off("transformstart transform transformend dragstart drag dragend tap"),this.renderer.locked=!1);var i,o=this.hammer=new r(t,{prevent_default:!0,drag:!0,drag_block_vertical:!0,drag_block_horizontal:!0,drag_min_distance:10,transform:!0,transform_always_block:!0,tap:!0});o.on("transformstart",function(){var t=(e.subway,e.renderer);t.locked=!0}),o.on("transform",function(t){var n=(e.subway,e.renderer);t.gesture&&t.gesture.preventDefault(),i=n.scaleRatio*t.gesture.scale,n._setCSSTransform(0,0,t.gesture.scale)}),o.on("transformend",function(t){var n=(e.subway,e.renderer);n.locked=!1,t.gesture&&t.gesture.preventDefault(),t.gesture.stopDetect(),n._clearCSSTransform();var o=n.getPointFromPixel(new Coords(n.deviceWidth/2,n.deviceHeight/2));if(n.zoom(o.x,o.y,i),e.popupWindow){var r=n.getPixelFromPoint(e.popupWindow.getPoint());e.popupWindow.setPosition(r.x,r.y)}e.trigger("transformend")});var s,u;o.on("dragstart",function(t){var i=(e.subway,e.renderer);i.locked||(t.gesture&&t.gesture.preventDefault(),origin=i.getOriginPoint(),s=origin.x,u=origin.y)}),o.on("drag",function(t){var i=(e.subway,e.renderer);i.locked||(t.gesture&&t.gesture.preventDefault(),i.move(t.gesture.deltaX,t.gesture.deltaY))}),o.on("dragend",function(t){var i=(e.subway,e.renderer);if(!i.locked){if(t.gesture&&t.gesture.preventDefault(),null==s||null==u)return i._clearCSSTransform(),void 0;var n=i.isOutOfBounds(s,u,t.gesture.deltaX,t.gesture.deltaY);n&&(t.gesture.deltaX=n.delta_x,t.gesture.deltaY=n.delta_y);var o=s+i.getPointUnitFromPixelValue(t.gesture.deltaX),r=u+i.getPointUnitFromPixelValue(t.gesture.deltaY);e.popupWindow&&e.popupWindow.move(t.gesture.deltaX,t.gesture.deltaY),i.moveTo(o,r),s=null,u=null}}),o.on("tap",function(i){var o=e.subway,r=e.renderer;if(i.gesture&&i.gesture.preventDefault(),(!i.target||!i.target.handled)&&i.gesture&&1===i.gesture.touches.length){var s=t.getBoundingClientRect(),u=i.gesture.touches[0],d=new Coords(u.clientX-s.left,u.clientY-s.top);e.hidePopupWindow();var l=r.getPointFromPixel(d),c=o.findNearestStation(l,"pixel",r.tolerance||16);a.addStat(STAT_CODE.SUBWAY_STATION_MARKER_CLICK),n.update({query:{station_uid:c.uid}},{replace:!0,trigger:!1}),e.popupStationWindow(c,{zoomToNormal:!1,isNotification:!1})}})},bind:function(){listener.on("subway","swZoomIn",this.zoomIn,this),listener.on("subway","swZoomOut",this.zoomOut,this),listener.on("common","sizechange",this.onSizeChange,this)},zoomIn:function(){var e,t=this.renderer,i=this.popupWindow;t.isMaxScale()||(t.zoomIn(),i&&(e=t.getPixelFromPoint(i.getPoint()),i.setPosition(e.x,e.y))),listener.trigger("subway","swZoomEnd",{isMinScale:t.isMinScale(),isMaxScale:t.isMaxScale()})},zoomOut:function(){var e,t=this.renderer,i=this.popupWindow;t.isMinScale()||(t.zoomOut(),i&&(e=t.getPixelFromPoint(i.getPoint()),i.setPosition(e.x,e.y))),listener.trigger("subway","swZoomEnd",{isMinScale:t.isMinScale(),isMaxScale:t.isMaxScale()})},isMaxScale:function(){return this.renderer?this.renderer.isMaxScale():!1},isMinScale:function(){return this.renderer?this.renderer.isMinScale():!1},initCenterLocation:function(){var t=this,i=this.params;if(i&&i.query&&i.query.station_uid)this.popupStationWindow({uid:i.query.station_uid},{zoomToNormal:!0,isNotification:!1,successCallback:function(){t.$el.css({visibility:""})}});else if(i&&i.query&&i.query.line_uid);else{var n=e("common:widget/geolocation/location.js");n.hasExactPoi()&&this.subway.cityCode==n.getCityCode()&&this.onGeoSuccess({point:n.getCenterPoi()})}t.$el.css({visibility:""})},onGeoSuccess:function(e){var t=this;if(e){var i=this.subway.findNearestStation(e.point,"point",1e6);this.popupStationWindow(i,{zoomToNormal:!0,isNotification:!0,successCallback:function(){t.$el.css({visibility:""})}})}},onSizeChange:function(e,t){var i=this.renderer,n=this.popupWindow,o=t?t.width:window.innerWidth,r=t?t.height:window.innerHeight,s=r-$(".common-widget-nav").height();if($("#subway-holder").css("height",s+"px"),i&&i.resize(o,r),n){var a=i.getPixelFromPoint(n.getPoint());n.setPosition(a.x,a.y)}},popupStationWindow:function(e,t){var i=this;i.renderer.locked||e&&this.subway.getStationExt("inf",e.uid,$.proxy(function(e){i.renderer.locked=!0,t.zoomToNormal&&i.renderer.zoom(e.station.x,e.station.y,1),i.showPopupWindow({notification:t.isNotification,x:e.station.x,y:e.station.y,uid:e.station.uid,lng:e.points.split(",")[0],lat:e.points.split(",")[1],station:e.station,lines:e.lines}),i.renderer.locked=!1,t.successCallback&&t.successCallback()},i),$.proxy(function(){t.failureCallback&&t.failureCallback()},i))},showPopupWindow:function(t){var i=this.renderer;this.popupWindow=this.popupWindow||e("subway:widget/popupwindow/popupwindow.js"),this.popupWindow.init(t),this.popupWindow.show({x:i.deviceWidth/2,y:i.deviceHeight/2},function(e,n){i.moveTo(-t.x,-t.y+i.getPointUnitFromPixelValue(n))})},hidePopupWindow:function(){this.popupWindow&&this.popupWindow.destroy()}})});