define("place:widget/order/order.js",function(e,t,i){"use strict";var a=e("common:widget/popup/popup.js"),o=e("place:static/js/vcode.js"),r=(e("common:static/js/util.js"),e("common:widget/url/url.js"));i.exports={ERRORMSG:{PHONEEMPTY:"请填写手机号码",PHONEERROR:"您输入的手机号码有误，请重新输入",NAMEERROR:"请输入正确姓名确保顺利入住",TIMEERROR:"抱歉！预定日期范围错误，请点击屏幕重新选择！",PRICEERROR:"抱歉！您预订的酒店价格发生变化，请点击屏幕确认重新确认。",FORMORDER:"抱歉！填写内容有误，请点击屏幕返回检查填写内容！",VALIDATEERROR:"验证码填写错误，请点击屏幕重新填写！",ROOMERROR:"抱歉！您预订的房间数超过剩余房量，请点击屏幕确认重新选择。",REPEATERROR:"系统不支持重复预定",CONTACTNAMEERROR:"身份证姓名请输入两个以上汉字",CONTACTIDERROR:"请输入有效的身份证号",REPEATPHONE:"手机号已经被其他身份证号注册，请更换",DEFAULT:"抱歉！发生未知错误，请点击屏幕返回重试！"},init:function(e){var t=this,i=e.data;this.kehuduan=e.kehuduan||0,this.wrapper=$("#hotelOrder"),this.totalPrice=$("#priceTotal"),this.$gwjBonusNum=$(".gwj-bonusnum"),i&&t.renderRoom(i),t.bind(),t.vcode=new o({el:$(".verifycode-img")}),this.room_info=i},bind:function(){var e=this;this.wrapper.find("select").on("change",function(t){e.changeSelect(t)}),$("#submitButton").on("click",$.proxy(e.submitData,e)),$(".gwj-kehuduan-bonus").on("click",function(){location.href=$(this).attr("attr-href")})},maxRoom:function(e){if(e){var t=3;return $.each(e,function(i){e[i].room_left<t&&(t=e[i].room_left)}),t}},roomPrice:function(e){if(e){var t,i=0;return $.each(e,function(a){t=parseInt(e[a].price,10),i+=t}),i}},renderRoom:function(e){for(var t=this,i=t.maxRoom(e),a=t.roomPrice(e),o=1;i>=o;o++){var r=[];r.push('<option value="'+o+'">'+o+"间</option>"),this.wrapper.find("select").append(r.join(""))}this.totalPrice.attr("single",a).html(a)},changeSelect:function(e){var t=e.target,i=$(t),a=$(i[0][i[0].selectedIndex]),o=a.val(),r=this.totalPrice.attr("single"),n=this.$gwjBonusNum;$(t).parent().children("em").html(a.text()),this.totalPrice.html(r*o),this.wrapper.find("input[name=room_num]").val(o),n.length&&n.html(n.data("datenum")*o),this.guestItemOperator(o)},guestItemOperator:function(e){var t=$("#moreGuest input"),i=t.length;if(e>i)for(var a=1;e-i>a;a++){var o=[];o.push('<div class="guest-item guest-name"><em class="icon guest-icon"></em><input type="text" maxlength="20" class="guest" index='+(i+a)+' name="guests" value="" placeholder="姓名,每间填1人" /></div>'),$("#moreGuest").append(o.join(""))}else $.each(t,function(){var t=$(this).attr("index");t>e-1&&$(this).parent().remove()})},getPrices:function(e){var t=[];if(e)return $.each(e,function(){t.push({price:this.price,date:this.date})}),JSON.stringify(t)},getAllData:function(e){var t=this,i={},a=[];return this.wrapper.find("input").each(function(){i[$(this).prop("name")]=$(this).val()}),i.prices=this.totalPrice.attr("room_price")?this.totalPrice.attr("room_price"):t.getPrices(e),$.each($('input[name="guests"]'),function(){a.push(encodeURI($(this).val()))}),i.guests=a.join(","),i},validateData:function(t){var i=t.phone,o=t.guests.split(","),r=t.contact_name,n=t.contact_identity,s=t.code,c=/^[\u4E00-\u9FA5]+$/,u=/^[A-Za-z]+$/,d=/^[\u0391-\uFFE5]{2,}$/,R=e("place:static/js/identityValidate.js"),l=parseInt(this.wrapper.find("input[name=src_need_identity]").val()),h=!0;if($.each(o,function(e){var e=decodeURI(this);return c.test(e)||u.test(e)||(h=!1),h}),""===i)a.open({text:this.ERRORMSG.PHONEEMPTY,autoCloseTime:1500});else if(-1==i.search(/^((1(5[0-9]|8[0-9]|3[0-9]|47))+\d{8})$/))a.open({text:this.ERRORMSG.PHONEERROR,autoCloseTime:1500});else if(h)if(l&&!d.test(r))a.open({text:this.ERRORMSG.CONTACTNAMEERROR,autoCloseTime:1500});else if(l&&!R.validate(n))a.open({text:this.ERRORMSG.CONTACTIDERROR,autoCloseTime:1500});else{if(""!==s&&4==s.length)return!0;a.open({text:this.ERRORMSG.VALIDATEERROR,autoCloseTime:1500})}else a.open({text:this.ERRORMSG.NAMEERROR,autoCloseTime:1500})},submitData:function(){var e=this,t=e.getAllData(this.room_info);e.validateData(t)&&e.handleOrderSubmit(t)},addLayer:function(){if(0==$("#bmap_pop_cover").length){var e=document.createElement("div");e.id="bmap_pop_cover",$.extend(e.style,{background:"rgba(0, 0, 0, 0.2)",height:"100%",width:"100%",top:"0px",left:"0px",zIndex:"80000",position:"absolute",overflow:"hidden",display:"block"}),$("#wrapper").append(e)}else $("#bmap_pop_cover").css("display","block")},handleOrderSubmit:function(e){var t=this,i=this.totalPrice.attr("single"),o=this.kehuduan,n=o?"webview":"maponline",s=o?"/kehuduan=1":"",c="/detail?qt=order&from="+n;$.ajax({type:"POST",url:c,dataType:"json",data:e,success:function(e){switch(e.errorNo){case 0:r.navigate("/mobile/webapp/place/order/qt=thirdsrc_order_success&order_id="+e.order_id+s);break;case 10004:t.addLayer(),a.open({text:t.ERRORMSG.TIMEERROR,autoCloseTime:!1,isTouchHide:!0});break;case 10006:case 10007:case 10008:t.addLayer(),a.open({text:t.ERRORMSG.FORMORDER,autoCloseTime:!1,isTouchHide:!0});break;case 10010:t.addLayer(),a.open({text:t.ERRORMSG.VALIDATEERROR,autoCloseTime:!1,isTouchHide:!0});break;case 30002:t.addLayer(),a.open({text:t.ERRORMSG.ROOMERROR,autoCloseTime:!1,isTouchHide:!0}),t.HandelRoomChange(i,e.room_num);break;case 30005:t.addLayer(),a.open({text:t.ERRORMSG.PRICEERROR,autoCloseTime:!1,isTouchHide:!0}),t.HandelPriceChange(e.prices);break;case 30006:t.addLayer(),a.open({text:t.ERRORMSG.REPEATERROR,autoCloseTime:!1,isTouchHide:!0});break;case 40003:t.addLayer(),a.open({text:t.ERRORMSG.REPEATPHONE,autoCloseTime:!1,isTouchHide:!0});break;default:var o=e.errorNo.toString().substr(0,1),n=encodeURIComponent(e.errorMsg);switch(o){case"1":case"3":case"4":t.addLayer(),a.open({text:t.ERRORMSG.DEFAULT,autoCloseTime:!1,isTouchHide:!0});break;case"2":case"5":default:r.navigate("/mobile/webapp/place/order/qt=hotel_error&msg="+n+s)}}t.vcode.refreshVcode()},error:function(){$(".common-widget-popup").hide(),t.addLayer(),a.open({text:t.ERRORMSG.DEFAULT,autoCloseTime:!1,isTouchHide:!0}),t.vcode.refreshVcode()}})},HandelRoomChange:function(e,t){var i,a=this.wrapper.find(".number");a.html(t+"间"),this.wrapper.find("input[name=room_num]").val(t);var o=$("select option");$.each(o,function(){i=$(this).val(),i>t&&$(this).remove()}),$(o[t-1]).attr("selected","selected");var r=$("#moreGuest input");$.each(r,function(){i=$(this).attr("index"),i>t-1&&$(this).parent().remove()}),this.totalPrice.html(e*t)},HandelPriceChange:function(e){var t=this.getPrices(e),i=this.roomPrice(e),a=this.wrapper.find("input[name=room_num]").val();this.totalPrice.html(i*a),this.totalPrice.attr("single",i),this.totalPrice.attr("room_price",t)}}});