define("common:widget/geolocation/html5geolocation.js",function(t,e,o){"use strict";var i=(t("common:widget/geolocation/location.js"),t("common:widget/stat/metrics-stat.js")),a={host:"http://loc.map.baidu.com/wloc?",param:{x:"",y:"",r:"",prod:"maponline"},getReqQuery:function(t,e,o){var i={x:t||"",y:e||"",r:o||""},a=[],n=this;return $.extend(n.param,i),$.each(n.param,function(t){a.push(t+"="+n.param[t])}),a.join("&")},request:function(t,e){var o={};o._callback=function(t){e&&e(t)},window.baidu=o;var i=this.host+t+"&addr=city|district|street|city_code&fn=_callback&t="+(new Date).getTime();$.ajax({url:i,dataType:"jsonp"}),this._delay=window.setTimeout(function(){listener.trigger("common.geomethod","fail",{message:"html5 geolocation fail"})},15e3)}},n={getCurrentPosition:function(t,e,o){return navigator.geolocation.getCurrentPosition(t,e,o)},watchPosition:function(t,e,o){return navigator.geolocation.watchPosition(t,e,o)},clearWatch:function(t){navigator.geolocation.clearWatch(t)}},c={init:function(t){this._data=t||{},this._config={enableHighAccuracy:!0,maximumAge:6e4,timeout:this._data.par||3e4,accuracy:2e8},this._getCurrentPosition(n)},_getCurrentPosition:function(t){i.addStat("geo","html5_geo_all",1,!0),t.getCurrentPosition(this._onSuccess,this._onFailure,this._config)},_onSuccess:function(t){var e,o,a=c;e=t.coords,o=e.accuracy,o<a._config.accuracy&&0!=e.longitude&&0!=e.latitude?a._getPosSuccess(t,{success:a.onWlocSuccess}):listener.trigger("common.geomethod","fail",{}),i.addStat("geo","wlan_geo_radius",parseInt(o,10))},_onFailure:function(t){i.addStat("geo","html5_geo_fail",{error:t.code,messgae:t.message},!0),listener.trigger("common.geomethod","fail",t)},_isUserDeny:function(t){return t&&1==t.code?util.isIOS()&&"user denied geolocation"==t.message.toLowerCase()||util.isAndroid()?!0:!1:void 0},_getPosSuccess:function(t){if(t){var e=this,o=t.coords;if(o){var n=a.getReqQuery(o.longitude,o.latitude,o.accuracy);e._isFirstSetLoc=!0;var c=e._data.id;a.request(n,function(t){if(a._delay&&window.clearTimeout(a._delay),"object"==typeof t){var e={},n=t.addr;if(!t.point)return listener.trigger("common.geomethod","fail",{message:"has no point"}),void 0;e={addr:{city:n.city,cityCode:n.city_code,district:n.district,street:n.street,accuracy:o.accuracy},point:t.point},$.extend(e,{type:"html5",isExactPoi:t.point?!0:!1,isSaveLocInCookie:!0}),i.addStat("geo","html5_get_geo_suc",{id:c},!0),listener.trigger("common.geomethod","success",e)}})}}}};o.exports=c});