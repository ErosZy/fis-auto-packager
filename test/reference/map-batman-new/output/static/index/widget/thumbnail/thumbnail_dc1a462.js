define("index:widget/thumbnail/thumbnail.js",function(t,i,e){var s=t("common:static/js/util.js"),o=(t("common:widget/url/url.js"),t("common:widget/popup/popup.js")),n=t("common:widget/geolocation/location.js"),a=t("common:widget/stat/stat.js"),h=t("index:widget/historycity/historycity.js"),r={type:0,level:16,height:101,width:window.innerWidth-22,url:null,host:"http://snap.map.baidu.com/?qt=snap&data="};e.exports={flag:{appreszie:!1,wait:void 0},TIMEOUT:8e3,state:"start",init:function(){this.prevPoint=void 0,this.render(),this.bind()},render:function(){this.thumbImg=$(".thumb-img"),this.thumbWrap=$(".thumb-wrap"),this.locbarTxt=$(".locbar-txt"),this.centerMarker=$(".center-marker"),this.geoBtn=$(".thumb-left"),this.inBtn=$(".in-btn"),this.errorCnt=$(".error-cnt"),this.thumbLink=$(".thumb-link"),this.setState("start")},bind:function(){var t=this;t.geoBtn.on("click",function(i){a.addStat(STAT_CODE.STAT_THUNB_START_GEO),t.startGeo(),i.stopImmediatePropagation(),i.stopPropagation()}),t.thumbImg.on("load",function(){t.errorCnt.hide(),t.thumbImg.show(),t.geoBtn.show(),t.hideLoading()}),t.thumbImg.on("error",function(){t.errorCnt.show(),t.thumbImg.hide(),t.centerMarker.hide(),t.hideLoading()}),listener.on("common.geolocation","success",function(){this.successCBK()},this),listener.on("common.geolocation","fail",function(){this.failCBK()},this)},successCBK:function(){this.flag.appreszie||(listener.on("common","sizechange",function(){this._appReSize()},this),this.flag.appreszie=!0);var t={cityName:n.getCity(),cityId:n.getCityCode(),cityeng:""};h._localStorage(t),this.setState("success")},failCBK:function(){this.setState("fail")},setState:function(t){switch(this.flag.state=t,this.addStateToLog(t),t){case"start":this.state="start",this.showLoading(),this._startLoc(),this.waitForLoc(8);break;case"success":this.state="success",this.hideLoading(),this.setLocation(),this.flag.wait&&window.clearTimeout(this.flag.wait);break;case"fail":this.state="fail",this.hideLoading(),this.centerMarker.hide(),o.open({text:"无法获取您的精确定位，请开启浏览器定位功能，刷新页面并选择允许定位"}),this.setLocation(),this.flag.wait&&window.clearTimeout(this.flag.wait)}},addStateToLog:function(t){if("success"===t||"fail"===t){var i={code:STAT_CODE.STAT_THUMB_IMG_CLICK,state:t};this.thumbLink.data("log",JSON.stringify(i))}},startGeo:function(){this.setState("start"),n.startGeo()},_startLoc:function(){var t=n.getLocation();t&&"ip"!==t.type?this.successCBK():this.waitForLoc()},waitForLoc:function(){var t=this;t.flag.wait&&window.clearTimeout(t.flag.wait),t.flag.wait=window.setTimeout(function(){"success"!=t.state&&t.failCBK()},this.TIMEOUT)},setLocation:function(){var t=n.getCenterPoi();this._unEqualPoint(t)?(this.prevPoint=t,this._setThumbUrl()):void 0!=this.prevPoint&&this.hideLoading(),this._setLocBarAddress(),this._setGeoBtnStatus(),this._setSearchBoxCity()},showLoading:function(){s.showLoading(this.thumbWrap),this.locbarTxt.html("正在定位您的位置...")},hideLoading:function(){s.hideLoading(this.thumbWrap)},_setLocBarAddress:function(t){var i=t||n.getAddress();this.locbarTxt.html(i)},_setSearchBoxCity:function(t){var t=t||n.getCity();$(".se-city-wd").html(t)},_setGeoBtnStatus:function(){n.hasExactPoi()?this.geoBtn.removeClass("geo-fail"):this.geoBtn.addClass("geo-fail")},_setThumbUrl:function(t){var i=this,e=t||i._getThumbUrl();n.hasExactPoi()?i.centerMarker.show():i.centerMarker.hide(),i.thumbImg.attr("src",e)},_appReSize:function(){var t=this;s.isAndroid()?setTimeout(function(){r.width=window.innerWidth-22},800):r.width=window.innerWidth-22,t._setThumbUrl()},_equalPoint:function(t){return this.prevPoint&&this.prevPoint.x==t.x&&this.prevPoint.y==t.y},_unEqualPoint:function(t){return void 0==this.prevPoint||t.x!=this.prevPoint.x||t.y!=this.prevPoint.y},_getThumbUrl:function(t){r.level=0==r.type?"全国"==n.getCity()?3:n.hasExactPoi()?16:10:10,void 0==t&&(t=n.getCenterPoi());var i={retype:1,src:"webapp",level:r.level,center:t.x+" "+t.y,height:101,width:r.width,coordtype:"M",pictype:r.type};return r.host+JSON.stringify(i)}}});